<script>
/* =========================================================
   PENNY SCANNER // LIVE ‚Äî FIXED + RULEBOOK v2
   - Fixes scoring + alert logic bugs
   - Adds real trade rulebook when criteria met
   - Uses proxy mode for Chrome Android stability
   ========================================================= */

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CONFIG
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const CFG = {
  PRICE_MIN: 0.20,
  PRICE_MAX: 50.00,
  MCAP_MAX_B: 5,                  // user cap: exclude > $5B
  MIN_DOLLAR_VOL: 1_500_000,      // minimum daily $ volume (liquidity filter)
  MIN_VOL_RATIO: 2.5,            // "in play" threshold
  SCAN_MAX: 14,                   // momentum scan tickers per run
  USE_PROXY_DEFAULT: true,        // Chrome Android friendly
  PROXY: "https://r.jina.ai/http://", // CORS proxy
  TZ: "America/New_York"
};

const LSKEY = {
  alerts: "ps_alerts",
  trig: "ps_trig",
  settings: "ps_settings"
};

let SETTINGS = {
  accountSize: 40000,     // you can change in-app (Rulebook shows sizing)
  riskPctHC: 0.0075,      // 0.75% risk for High Conviction
  riskPctWatch: 0.0040,   // 0.40% risk for Watch
  maxPosPct: 0.20,        // cap allocation per position
  useProxy: CFG.USE_PROXY_DEFAULT
};

try { SETTINGS = { ...SETTINGS, ...(JSON.parse(localStorage.getItem(LSKEY.settings) || "{}")) }; } catch(e) {}
function saveSettings(){ try{ localStorage.setItem(LSKEY.settings, JSON.stringify(SETTINGS)); }catch(e){} }

function prox(url){
  if(!SETTINGS.useProxy) return url;
  return CFG.PROXY + url.replace(/^https?:\/\//, "");
}

function fmtPrice(p){
  if(p == null || Number.isNaN(p)) return "‚Äî";
  if(p < 1) return "$" + p.toFixed(4);
  if(p < 10) return "$" + p.toFixed(3);
  return "$" + p.toFixed(2);
}
function fmtNum(n){
  if(n == null || Number.isNaN(n)) return "‚Äî";
  if(n >= 1e9) return (n/1e9).toFixed(2) + "B";
  if(n >= 1e6) return (n/1e6).toFixed(1) + "M";
  if(n >= 1e3) return (n/1e3).toFixed(1) + "K";
  return String(Math.round(n));
}
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* =========================================================
   KNOWN STOCKS DATABASE (you can keep as-is)
   (Using your original KNOWN unchanged)
========================================================= */
const KNOWN = window.KNOWN || {
  OLB:{name:'OLB Group Inc',exchange:'NASDAQ',status:'dump',statusLabel:'DUMP ALERT',mentions:47,mentionSpike:1467,score:38,
    scores:{catalyst:8,fundamental:2,technical:5,warrior:5,sentiment:8,rr:3,liquidity:2,volatility:5},
    scoreMax:{catalyst:20,fundamental:15,technical:20,warrior:15,sentiment:10,rr:15,liquidity:10,volatility:10},
    scoreColors:{catalyst:'#2979ff',fundamental:'#ff3060',technical:'#ffb800',warrior:'#9d6eff',sentiment:'#00ff88',rr:'#ff3060',liquidity:'#ffb800',volatility:'#2979ff'},
    indicators:[{label:'RSI (14)',val:'72 ‚Äî Overbought',cls:'bear'},{label:'MACD',val:'Bearish cross',cls:'bear'},{label:'VWAP',val:'Below VWAP',cls:'bear'},{label:'Volume vs Avg',val:'860√ó avg',cls:'bull'},{label:'Support',val:'$0.40',cls:'neut'},{label:'Resistance',val:'$1.05 (offering)',cls:'bear'}],
    wtFlags:[{label:'Vol ‚â• 3√ó avg',pass:true},{label:'Hard catalyst',pass:true},{label:'No ATM dilution',pass:false},{label:'Float < 10M',pass:true},{label:'No MNBD',pass:false},{label:'Clean base',pass:false}],
    dumpWarnings:['$3M placement Feb 18 ‚Äî day after +256% pump','Warrants at $0.92 ‚Üí massive overhead','Pattern: pump‚Üíoffering‚Üídump (3rd time)','Active Nasdaq MNBD notice'],
    catalyst:'PayPal global partnership ‚Äî real but immediately diluted',
    plan:{entry:'AVOID',stop:'N/A',target:'N/A'},note:'Classic post-pump dilution trap. Revisit in 3‚Äì4 weeks.'},
};

/* =========================================================
   STATE
========================================================= */
let currentTicker = null;
let currentTF = '15';
let currentDrawer = 'score';
let scannedTickers = {};
let momFilter = 'all';
let momentumTickers = [];
let alerts = [];
let triggered = [];
let redditData = [];
let priceCache = {};
let scanIntervalId = null;

/* IMPORTANT BUGFIX:
   Your code referenced criteria.dump but it didn‚Äôt exist.
   We add dump toggle + keep old toggles. */
let criteria = { vol3x:true, dilution:true, mention:true, wt:true, dump:true };

try{ alerts = JSON.parse(localStorage.getItem(LSKEY.alerts) || '[]'); }catch(e){}
try{ triggered = JSON.parse(localStorage.getItem(LSKEY.trig) || '[]'); }catch(e){}

function saveData(){
  try{
    localStorage.setItem(LSKEY.alerts, JSON.stringify(alerts));
    localStorage.setItem(LSKEY.trig, JSON.stringify(triggered));
  }catch(e){}
}

/* =========================================================
   DATA FETCH (Yahoo) + Intraday OHLCV (5m) for ATR/VWAP proxy
========================================================= */
async function fetchYahooQuote(sym){
  const url = prox(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(sym)}`);
  const r = await fetch(url);
  if(!r.ok) throw new Error("quote HTTP " + r.status);
  const d = await r.json();
  return d?.quoteResponse?.result?.[0] || null;
}

async function fetchYahooChart(sym, interval="5m", range="5d"){
  const url = prox(`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(sym)}?interval=${interval}&range=${range}`);
  const r = await fetch(url);
  if(!r.ok) throw new Error("chart HTTP " + r.status);
  const d = await r.json();
  const res = d?.chart?.result?.[0];
  if(!res) return null;
  return res;
}

function calcATR(highs, lows, closes, period=14){
  if(!highs || !lows || !closes) return null;
  const n = Math.min(highs.length, lows.length, closes.length);
  if(n < period+2) return null;
  const tr = [];
  for(let i=1;i<n;i++){
    const h = highs[i], l = lows[i], pc = closes[i-1];
    if([h,l,pc].some(v=>v==null)) continue;
    const t = Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc));
    tr.push(t);
  }
  if(tr.length < period) return null;
  // simple ATR
  const slice = tr.slice(-period);
  const atr = slice.reduce((a,b)=>a+b,0) / slice.length;
  return atr;
}

function calcVWAPProxy(closes, volumes){
  // intraday vwap proxy from 5m bars (close*vol)
  if(!closes || !volumes) return null;
  const n = Math.min(closes.length, volumes.length);
  let pv=0, v=0;
  for(let i=Math.max(0,n-78); i<n; i++){ // ~6.5h of 5m bars
    const c=closes[i], vol=volumes[i];
    if(c==null || vol==null) continue;
    pv += c*vol;
    v += vol;
  }
  if(v<=0) return null;
  return pv/v;
}

/* =========================================================
   REDDIT (ApeWisdom) ‚Äî unchanged behavior but robust
========================================================= */
async function fetchReddit(){
  const ts = document.getElementById('redditTS');
  if(ts) ts.textContent = 'FETCHING...';
  try{
    const r = await fetch('https://apewisdom.io/api/v1.0/filter/pennystocks/page/1');
    const d = await r.json();
    if(d?.results){
      redditData = d.results;
      renderReddit(redditData);
      if(ts) ts.textContent = 'LIVE // APEWISDOM.IO // ' + new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
      checkRedditAlerts(redditData);
      return;
    }
  }catch(e){}
  // fallback cached
  redditData = Object.values(KNOWN).map(s=>({
    ticker:s.ticker||Object.keys(KNOWN).find(k=>KNOWN[k]===s),
    name:s.name, mentions:s.mentions||0, upvotes:Math.round((s.mentions||0)*3),
    mentions_24h_ago: Math.max(0, Math.round((s.mentions||0)/(1+(s.mentionSpike||0)/100)))
  }));
  renderReddit(redditData);
  if(ts) ts.textContent = 'CACHED (network unavailable)';
}

/* =========================================================
   SCORING ENGINE v2 (Fix + Edge)
========================================================= */
async function liveScore(sym){
  // 1) Quote
  const q = await fetchYahooQuote(sym);
  if(!q) return null;

  const price = q.regularMarketPrice ?? q.postMarketPrice ?? q.preMarketPrice;
  const prevClose = q.regularMarketPreviousClose ?? q.previousClose;
  const open = q.regularMarketOpen ?? price;
  const high = q.regularMarketDayHigh ?? price;
  const low  = q.regularMarketDayLow ?? price;
  const volume = q.regularMarketVolume ?? 0;
  const avgVolume = q.averageDailyVolume3Month ?? q.averageDailyVolume10Day ?? Math.max(1, volume);

  const marketCap = q.marketCap ?? null;
  const sharesOut = q.sharesOutstanding ?? null; // not float but better than null
  const fiftyTwoWeekLow  = q.fiftyTwoWeekLow ?? (price*0.5);
  const fiftyTwoWeekHigh = q.fiftyTwoWeekHigh ?? (price*2);
  const name = q.longName || q.shortName || sym;
  const exchange = q.fullExchangeName || q.exchange || 'US';

  // Basic derived
  const chg = (prevClose && price!=null) ? (price - prevClose) : 0;
  const chgPct = (prevClose && prevClose>0) ? (chg/prevClose*100) : 0;
  const volRatio = avgVolume>0 ? (volume/avgVolume) : 0;
  const dollarVol = (price||0) * (volume||0);
  const mcapB = marketCap ? marketCap/1e9 : null;

  // Fetch 5m bars for ATR + VWAP proxy (best ‚Äúscience-ish‚Äù edge we can do without backend)
  let atr=null, atrPct=null, vwap=null, vwapRel=null;
  try{
    const chart = await fetchYahooChart(sym, "5m", "5d");
    const qts = chart?.indicators?.quote?.[0];
    const closes = qts?.close || [];
    const highs = qts?.high || [];
    const lows = qts?.low || [];
    const vols = qts?.volume || [];
    atr = calcATR(highs,lows,closes,14);
    atrPct = (atr && price) ? (atr/price*100) : null;
    vwap = calcVWAPProxy(closes, vols);
    vwapRel = (vwap && price) ? ((price - vwap)/vwap*100) : null;
  }catch(e){}

  // 2) HARD FILTERS
  const dumpWarnings = [];
  let hardReject = false;

  if(price == null || Number.isNaN(price)) { hardReject=true; dumpWarnings.push("Price unavailable"); }
  if(price != null && (price < CFG.PRICE_MIN || price > CFG.PRICE_MAX)){
    hardReject = true;
    dumpWarnings.push(`Price ${fmtPrice(price)} outside ${CFG.PRICE_MIN}‚Äì${CFG.PRICE_MAX}`);
  }
  if(mcapB != null && mcapB > CFG.MCAP_MAX_B){
    hardReject = true;
    dumpWarnings.push(`Market cap ${mcapB.toFixed(2)}B > ${CFG.MCAP_MAX_B}B cap`);
  }
  if(dollarVol < CFG.MIN_DOLLAR_VOL){
    dumpWarnings.push(`Illiquid: $${fmtNum(dollarVol)}/day dollar volume < ${fmtNum(CFG.MIN_DOLLAR_VOL)}`);
  }

  // 3) Score buckets (0..115 total)
  // New buckets: Liquidity + Volatility included (edge-like filters)

  // Catalyst (0-20) ‚Äì uses volRatio + large move (proxy for ‚Äúnews‚Äù)
  let catalyst = 0;
  if(volRatio >= 10) catalyst += 10;
  else if(volRatio >= 5) catalyst += 7;
  else if(volRatio >= 3) catalyst += 5;
  else if(volRatio >= 2) catalyst += 2;

  if(chgPct >= 30) catalyst += 8;
  else if(chgPct >= 15) catalyst += 6;
  else if(chgPct >= 7) catalyst += 4;
  else if(chgPct >= 3) catalyst += 2;

  if(chgPct <= -20) catalyst -= 3;
  catalyst = clamp(catalyst, 0, 20);

  // Fundamentals (0-15) ‚Äì limited with free data. Mainly penalize micro-micro + leverage proxy.
  let fundamental = 9;
  if(marketCap != null && marketCap < 15e6) fundamental -= 4;
  else if(marketCap != null && marketCap < 75e6) fundamental -= 2;
  // Profitability proxy via P/E if available
  const trailingPE = q.trailingPE ?? null;
  if(trailingPE != null && trailingPE > 0 && trailingPE < 20) fundamental += 3;
  if(trailingPE != null && trailingPE > 80) fundamental -= 2;
  fundamental = clamp(fundamental, 0, 15);

  // Technical (0-20) ‚Äì structure + VWAP relationship + extension penalties
  let technical = 0;
  if(volRatio >= CFG.MIN_VOL_RATIO) technical += 6; else if(volRatio >= 1.8) technical += 3;
  if(chgPct >= 5 && chgPct <= 35) technical += 7;
  if(chgPct > 35) { technical += 2; dumpWarnings.push(`Extended: +${chgPct.toFixed(1)}% (prefer pullback)`); }
  if(vwapRel != null){
    if(vwapRel >= 0.3) technical += 4;       // above vwap
    else if(vwapRel <= -0.3) technical -= 3; // below vwap
  }
  // Avoid too close to 52w high chase
  const fromHigh = (fiftyTwoWeekHigh && price) ? ((fiftyTwoWeekHigh - price)/fiftyTwoWeekHigh*100) : null;
  if(fromHigh != null){
    if(fromHigh > 35) technical += 3;  // not too extended
    else if(fromHigh < 10) technical -= 2; // near highs
  }
  technical = clamp(technical, 0, 20);

  // Warrior-style checklist (0-15)
  const floatM = sharesOut ? sharesOut/1e6 : null;
  const wtFlags = [
    {label:'RelVol ‚â• 3√ó', pass: volRatio >= 3},
    {label:'Move ‚â• +5%', pass: chgPct >= 5},
    {label:'Price 0.20‚Äì50', pass: price>=CFG.PRICE_MIN && price<=CFG.PRICE_MAX},
    {label:'Dollar vol ‚â• $1.5M', pass: dollarVol >= CFG.MIN_DOLLAR_VOL},
    {label:'Not > $5B', pass: !(mcapB != null && mcapB > CFG.MCAP_MAX_B)},
    {label:'VWAP not below -0.3%', pass: (vwapRel == null) ? true : vwapRel > -0.3}
  ];
  let warrior = Math.round((wtFlags.filter(f=>f.pass).length / wtFlags.length) * 15);

  // Sentiment (0-10) ‚Äì from Reddit mentions spike
  const redditEntry = redditData.find(r=>r.ticker === sym);
  let sentiment = 4;
  if(redditEntry){
    const old = redditEntry.mentions_24h_ago;
    const spike = old > 0 ? (redditEntry.mentions - old)/old*100 : null;
    if(spike != null && spike > 300) sentiment = 9;
    else if(spike != null && spike > 120) sentiment = 7;
    else if(redditEntry.mentions >= 6) sentiment = 6;
    else sentiment = 5;
  }
  sentiment = clamp(sentiment, 0, 10);

  // Risk/Reward (0-15) ‚Äì uses intraday range + ATR proxy
  let rr = 0;
  const dayRange = (high!=null && low!=null) ? (high-low) : null;
  if(dayRange && price){
    const rangePct = dayRange/price*100;
    if(rangePct >= 12) rr += 6;
    else if(rangePct >= 7) rr += 4;
    else if(rangePct >= 4) rr += 2;
  }
  if(atrPct != null){
    if(atrPct >= 8) rr += 7;
    else if(atrPct >= 5) rr += 5;
    else if(atrPct >= 3) rr += 3;
    else rr += 1;
  } else {
    rr += 2;
  }
  rr = clamp(rr, 0, 15);

  // Liquidity (0-10)
  let liquidity = 0;
  if(dollarVol >= 20_000_000) liquidity = 10;
  else if(dollarVol >= 10_000_000) liquidity = 8;
  else if(dollarVol >= 5_000_000) liquidity = 6;
  else if(dollarVol >= 2_500_000) liquidity = 4;
  else if(dollarVol >= 1_500_000) liquidity = 2;
  else liquidity = 0;

  // Volatility (0-10) ‚Äì sweet spot: not dead, not insane
  let volatility = 0;
  if(atrPct == null) volatility = 4;
  else if(atrPct >= 12) { volatility = 3; dumpWarnings.push(`Too wild: ATR ${atrPct.toFixed(1)}%`); }
  else if(atrPct >= 7) volatility = 9;
  else if(atrPct >= 4) volatility = 7;
  else if(atrPct >= 2) volatility = 5;
  else volatility = 2;

  // Deduction rules (pump risk)
  let deductions = 0;
  if(volRatio > 25 && chgPct > 80){ deductions -= 12; dumpWarnings.push(`Possible coordinated pump: RelVol ${volRatio.toFixed(0)}√ó, +${chgPct.toFixed(0)}%`); }
  if(dollarVol < CFG.MIN_DOLLAR_VOL) deductions -= 8;

  // Total (115)
  const scoreMax = {catalyst:20,fundamental:15,technical:20,warrior:15,sentiment:10,rr:15,liquidity:10,volatility:10};
  const scores = {catalyst,fundamental,technical,warrior,sentiment,rr,liquidity,volatility};
  const raw = Object.keys(scores).reduce((a,k)=>a+scores[k],0) + deductions;
  const total = clamp(Math.round(raw), 0, 115);

  // Status logic
  let status='reject', statusLabel='REJECTED';
  const dumpish = (dumpWarnings.length >= 2 && (volRatio > 8 || chgPct > 50)) || hardReject;
  if(dumpish){ status='dump'; statusLabel='DUMP ALERT'; }
  else if(total >= 82){ status='pass'; statusLabel='HIGH CONVICTION'; }
  else if(total >= 68){ status='watch'; statusLabel='WATCHLIST'; }

  // Indicators for drawer
  const rsiEst = chgPct > 20 ? `~80 Overbought` : chgPct > 10 ? `~65 Elevated` : chgPct < -10 ? `~30 Oversold` : `~50 Neutral`;
  const indicators = [
    {label:'Price', val:`${fmtPrice(price)} (${chgPct>=0?'+':''}${chgPct.toFixed(2)}%)`, cls:chgPct>=0?'bull':'bear'},
    {label:'Rel Volume', val:`${volRatio.toFixed(1)}√ó`, cls:volRatio>=3?'bull':volRatio>=1.8?'neut':'bear'},
    {label:'Dollar Volume', val:`$${fmtNum(dollarVol)}/day`, cls:dollarVol>=CFG.MIN_DOLLAR_VOL?'bull':'bear'},
    {label:'VWAP (proxy)', val: vwap? `${fmtPrice(vwap)} (${vwapRel>=0?'+':''}${vwapRel.toFixed(2)}%)` : 'N/A', cls:vwapRel==null?'neut':(vwapRel>=0?'bull':'bear')},
    {label:'ATR(14) %', val: atrPct!=null? `${atrPct.toFixed(1)}%` : 'N/A', cls:atrPct==null?'neut':(atrPct>=4 && atrPct<=12?'bull':atrPct<2?'bear':'neut')},
    {label:'RSI (est.)', val:rsiEst, cls:chgPct>20?'bear':chgPct<-10?'bull':'neut'},
    {label:'Day Range', val:(high!=null && low!=null)? `${fmtPrice(low)} ‚Äì ${fmtPrice(high)}` : 'N/A', cls:'neut'},
    {label:'Market Cap', val: marketCap? `$${fmtNum(marketCap)}` : 'N/A', cls:'neut'},
    {label:'Shares (out)', val: sharesOut? `${fmtNum(sharesOut)}`:'N/A', cls:'neut'},
    {label:'Exchange', val: exchange, cls:'neut'}
  ];

  // Build trade plan + rulebook
  const plan = buildPlanAndRulebook({
    sym, price, prevClose, open, high, low, chgPct, volRatio, dollarVol,
    atr, atrPct, vwap, vwapRel, status, total
  });

  return {
    ticker: sym,
    name,
    exchange,
    status, statusLabel,
    score: total,
    scores,
    scoreMax,
    scoreColors:{
      catalyst:'#2979ff',
      fundamental:'#ffb800',
      technical:'#9d6eff',
      warrior:'#00ff88',
      sentiment:'#ff6b35',
      rr:'#2979ff',
      liquidity:'#ffb800',
      volatility:'#2979ff'
    },
    indicators,
    wtFlags,
    dumpWarnings,
    catalyst:'Live score uses RelVol, VWAP proxy, ATR% + liquidity filters. (No filing detection without backend).',
    plan: plan.plan,
    rulebook: plan.rulebook,
    note: plan.note,
    // raw data
    price, prevClose, open, high, low, chg, chgPct, volRatio,
    floatM, mcapB, marketCap, dollarVol,
    atrPct, vwapRel,
    mentions: redditEntry?.mentions || 0
  };
}

/* =========================================================
   TRADE PLAN + RULEBOOK (Executable)
========================================================= */
function buildPlanAndRulebook(x){
  const {sym, price, prevClose, open, high, low, chgPct, volRatio, dollarVol, atrPct, vwap, vwapRel, status, total} = x;

  // Setup classification (simple + tradable)
  const gapPct = (prevClose && open) ? ((open-prevClose)/prevClose*100) : 0;
  const isGap = gapPct >= 6;
  const isMomentum = chgPct >= 12 && volRatio >= 3;
  const isBreakout = chgPct >= 6 && volRatio >= CFG.MIN_VOL_RATIO && vwapRel != null && vwapRel >= 0;
  const isReversal = chgPct <= -8 && volRatio >= 2;

  let setup = "No-Trade";
  if(status === 'dump') setup = "Avoid (Dump Risk)";
  else if(isGap && isMomentum) setup = "Gap-and-Go Momentum";
  else if(isBreakout) setup = "VWAP Reclaim Breakout";
  else if(isMomentum) setup = "Momentum Continuation";
  else if(isReversal) setup = "Mean Reversion (Only A+ conditions)";

  // Stop & target heuristics
  const stop = low ? low : (price ? price*0.92 : null);
  const stopDist = (price && stop) ? (price - stop) : null;
  const stopDistPct = (price && stopDist) ? (stopDist/price*100) : null;

  const riskPct = (total >= 82) ? SETTINGS.riskPctHC : SETTINGS.riskPctWatch;
  const riskAmt = SETTINGS.accountSize * riskPct;

  let shares = null;
  if(price && stopDist && stopDist > 0){
    shares = Math.floor(riskAmt / stopDist);
  }
  // cap allocation
  const maxSharesByAlloc = price ? Math.floor((SETTINGS.accountSize * SETTINGS.maxPosPct)/price) : null;
  if(shares != null && maxSharesByAlloc != null) shares = Math.min(shares, maxSharesByAlloc);

  // Targets as R-multiples (science-ish: expectancy management)
  const t1 = (price && stopDist) ? price + (1.0*stopDist) : null;
  const t2 = (price && stopDist) ? price + (2.0*stopDist) : null;
  const t3 = (price && stopDist) ? price + (3.0*stopDist) : null;

  const noTradeReasons = [];
  if(price != null && (price < CFG.PRICE_MIN || price > CFG.PRICE_MAX)) noTradeReasons.push("Price outside allowed range");
  if(dollarVol < CFG.MIN_DOLLAR_VOL) noTradeReasons.push("Dollar volume too low (slippage risk)");
  if(atrPct != null && atrPct < 1.8) noTradeReasons.push("Too dead (low volatility)");
  if(atrPct != null && atrPct > 14) noTradeReasons.push("Too wild (halt/spread risk)");
  if(volRatio < 1.6) noTradeReasons.push("Not in play (RelVol too low)");
  if(status === 'dump') noTradeReasons.push("Dump alerts active");

  const tradable = (status !== 'dump') && (total >= 68) && (noTradeReasons.length <= 1);

  const entryRules = [];
  const riskRules = [];
  const manageRules = [];

  // Entry rules depend on setup
  if(!tradable){
    entryRules.push("NO TRADE: do not enter. Wait for better setup or liquidity.");
  } else {
    if(setup.includes("Gap-and-Go")){
      entryRules.push("Entry A (preferred): break of High-of-Day (HOD) on 5m close above HOD with RelVol ‚â• 3√ó.");
      entryRules.push("Entry B (safer): first pullback to VWAP, then reclaim with 5m green candle.");
      entryRules.push("Invalidation: loss of VWAP on 5m close OR break of day low.");
    } else if(setup.includes("VWAP Reclaim")){
      entryRules.push("Wait for price to reclaim VWAP (proxy) and HOLD above it for 2 consecutive 5m closes.");
      entryRules.push("Entry trigger: break of pre-reclaim pivot / micro-resistance with volume expansion.");
      entryRules.push("Avoid chase: if +35% day move already, wait pullback.");
    } else if(setup.includes("Momentum Continuation")){
      entryRules.push("Only enter after consolidation: 3‚Äì8 x 5m candles tight range (no new lows).");
      entryRules.push("Entry trigger: break of consolidation high with volume expansion.");
      entryRules.push("If it fails breakout within 10‚Äì20 minutes ‚Üí exit (time stop).");
    } else if(setup.includes("Mean Reversion")){
      entryRules.push("Only if catalyst is real + RelVol ‚â• 3√ó and price reclaims VWAP.");
      entryRules.push("Entry trigger: 5m reversal pattern (higher low + strong green candle) near support.");
      entryRules.push("This is lowest edge setup: size down 50%.");
    }
  }

  // Risk rules (executable)
  if(tradable){
    riskRules.push(`Risk per trade: ${(riskPct*100).toFixed(2)}% of account ‚âà ${riskAmt.toFixed(0)} (account ${SETTINGS.accountSize}).`);
    if(stop != null) riskRules.push(`Hard stop: ${fmtPrice(stop)} (below Day Low / invalidation).`);
    if(stopDistPct != null) riskRules.push(`Stop distance: ${stopDistPct.toFixed(1)}% (${fmtPrice(price)} ‚Üí ${fmtPrice(stop)}).`);
    if(shares != null) riskRules.push(`Position size: ${shares} shares (capped at ${(SETTINGS.maxPosPct*100).toFixed(0)}% allocation).`);
    riskRules.push("Never average down. One stop = done.");
  }

  // Management rules
  if(tradable){
    manageRules.push(`Take profit: sell 1/3 at 1R (${t1?fmtPrice(t1):"N/A"}), 1/3 at 2R (${t2?fmtPrice(t2):"N/A"}).`);
    manageRules.push("Trail remainder: exit if 5m closes below VWAP OR below last 5m higher-low.");
    manageRules.push("Time stop: if no progress within 45‚Äì60 minutes after entry ‚Üí exit.");
    manageRules.push("If halt occurs: do NOT add. Only manage risk after reopen.");
  }

  // Note shown under plan
  let note = "";
  if(status === 'dump'){
    note = `DUMP ALERT: ${sym} flagged. Skip.`;
  } else if(total >= 82){
    note = `A+ candidate. Follow rulebook strictly. No chase.`;
  } else if(total >= 68){
    note = `B+ watch. Trade only if triggers print cleanly on 5m.`;
  } else {
    note = `Below threshold. Ignore unless conditions improve (RelVol + VWAP + liquidity).`;
  }

  const plan = {
    entry: tradable ? setup : "AVOID",
    stop: stop!=null? fmtPrice(stop) : "N/A",
    target: tradable ? (t2? fmtPrice(t2) : "2R") : "N/A",
    size: shares!=null? `${shares} sh` : "N/A"
  };

  const rulebook = {
    setup,
    tradable,
    gapPct,
    noTradeReasons,
    entryRules,
    riskRules,
    manageRules
  };

  return { plan, rulebook, note };
}

/* =========================================================
   UI RENDER (Drawers) ‚Äî replaces old renderLiveScore
========================================================= */
function renderLiveScore(r){
  const col = r.score>=82?'var(--acid)':r.score>=68?'var(--solar)':'var(--plasma)';
  const labels = {
    catalyst:'Catalyst',
    fundamental:'Fundamentals',
    technical:'Technical',
    warrior:'Checklist',
    sentiment:'Sentiment',
    rr:'R/R + Range',
    liquidity:'Liquidity',
    volatility:'Volatility'
  };

  const dumpHtml = r.dumpWarnings?.length ? `
    <div class="dump-box">
      <div class="dump-box-title">üö® Active Signals</div>
      ${r.dumpWarnings.map(w=>`<div class="dump-item">${w}</div>`).join('')}
    </div>` : '';

  // SCORE PANEL
  document.getElementById('dp-score').innerHTML = `
    ${dumpHtml}
    <div class="live-score-wrap">
      <div class="lsw-header">
        <div class="lsw-title">Live Score ‚Äî ${r.ticker}</div>
        <div class="lsw-grade" style="color:${col}">
          ${r.score}<span style="font-family:var(--mono);font-size:11px;color:var(--ink3)">/115</span>
        </div>
      </div>
      <div class="lsw-badges">
        <span class="ls-badge" style="background:var(--arcfaint);color:var(--arc);border:1px solid rgba(41,121,255,0.3)">LIVE</span>
        <span class="ls-badge" style="background:${r.score>=82?'var(--acidfaint)':r.score>=68?'var(--solarfaint)':'var(--plasmafaint)'};color:${r.score>=82?'var(--acid)':r.score>=68?'var(--solar)':'var(--plasma)'}">${r.statusLabel}</span>
        <span class="ls-badge" style="background:var(--lift);color:var(--ink2);border:1px solid var(--edge)">
          Proxy: ${SETTINGS.useProxy?'ON':'OFF'}
        </span>
      </div>

      <div class="data-row"><div class="dr-lbl">Price</div><div class="dr-val">${fmtPrice(r.price)}</div></div>
      <div class="data-row"><div class="dr-lbl">Change</div><div class="dr-val" style="color:${r.chgPct>=0?'var(--acid)':'var(--plasma)'}">${r.chgPct>=0?'+':''}${r.chgPct.toFixed(2)}%</div></div>
      <div class="data-row"><div class="dr-lbl">RelVol</div><div class="dr-val" style="color:${r.volRatio>=3?'var(--acid)':r.volRatio>=1.8?'var(--solar)':'var(--ink2)'}">${r.volRatio.toFixed(1)}√ó</div></div>
      <div class="data-row"><div class="dr-lbl">$ Volume</div><div class="dr-val">${fmtNum(r.dollarVol)}</div></div>
      <div class="data-row"><div class="dr-lbl">Reddit mentions</div><div class="dr-val">${r.mentions||0}</div></div>
    </div>

    <div class="score-bars">
      ${Object.keys(r.scores).map(k=>{
        const pct = Math.round(r.scores[k]/r.scoreMax[k]*100);
        return `
          <div class="sbar-row">
            <div class="sbar-lbl">${labels[k]}</div>
            <div class="sbar-track"><div class="sbar-fill" style="width:${pct}%;background:${r.scoreColors[k]||'var(--arc)'}"></div></div>
            <div class="sbar-val">${r.scores[k]}/${r.scoreMax[k]}</div>
          </div>`;
      }).join('')}
    </div>

    <div style="margin-top:10px" class="note-pill">
      <b>Rulebook Output:</b> ${r.rulebook?.setup || '‚Äî'} ‚Ä¢ ${r.rulebook?.tradable ? '<span style="color:var(--acid);font-weight:700">TRADEABLE</span>' : '<span style="color:var(--plasma);font-weight:700">NO TRADE</span>'}
      <br><span style="color:var(--ink3);font-size:9px;font-family:var(--mono)">Account: ${SETTINGS.accountSize} ‚Ä¢ Risk(HC): ${(SETTINGS.riskPctHC*100).toFixed(2)}% ‚Ä¢ Risk(W): ${(SETTINGS.riskPctWatch*100).toFixed(2)}%</span>
    </div>
  `;

  // SIGNALS PANEL
  document.getElementById('dp-indic').innerHTML = `
    <div class="ind-grid">
      ${r.indicators.map(i=>`
        <div class="ind-row">
          <div class="ind-lbl">${i.label}</div>
          <div class="ind-val ${i.cls}">${i.val}</div>
        </div>`).join('')}
    </div>
    <div style="margin-top:8px" class="note-pill" style="border-color:var(--arc)">
      <b>Science-ish edge:</b> Your score now penalizes low liquidity, extreme ATR%, and being below VWAP (proxy).
      These are the biggest killers for retail expectancy in microcaps.
    </div>
  `;

  // WT CHECK PANEL
  const pass = r.wtFlags?.filter(f=>f.pass).length || 0;
  document.getElementById('dp-flags').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-size:11px;color:var(--ink2)">Execution Checklist</div>
      <div style="font-family:var(--mono);font-size:11px;font-weight:700;color:${pass>=5?'var(--acid)':pass>=3?'var(--solar)':'var(--plasma)'}">${pass}/${r.wtFlags?.length||0}</div>
    </div>
    <div class="flags-wrap">
      ${r.wtFlags?.map(f=>`<div class="wflag ${f.pass?'wf-pass':'wf-fail'}">${f.pass?'‚úì':'‚úó'} ${f.label}</div>`).join('') || ''}
    </div>
    <div class="note-pill" style="border-color:var(--arc)"><b>Catalyst proxy:</b> ${r.catalyst}</div>
  `;

  // PLAN PANEL (NOW REAL)
  const rb = r.rulebook || {};
  const reasons = (rb.noTradeReasons && rb.noTradeReasons.length) ? rb.noTradeReasons.map(x=>`<div class="dump-item">${x}</div>`).join('') : '';
  document.getElementById('dp-plan').innerHTML = `
    <div class="plan-cells">
      <div class="pcell"><div class="pcell-lbl">Setup</div><div class="pcell-val pv-e">${r.plan.entry}</div></div>
      <div class="pcell"><div class="pcell-lbl">Stop</div><div class="pcell-val pv-s">${r.plan.stop}</div></div>
      <div class="pcell"><div class="pcell-lbl">Target</div><div class="pcell-val pv-t">${r.plan.target}</div></div>
    </div>

    ${(!rb.tradable && reasons) ? `<div class="dump-box"><div class="dump-box-title">‚ùå NO-TRADE REASONS</div>${reasons}</div>` : ''}

    <div class="note-pill" style="border-color:var(--acid)">
      <b>Entry Rules (execute on 5m):</b><br>
      ${(rb.entryRules||[]).map(x=>`‚Ä¢ ${x}`).join('<br>')}
    </div>

    <div class="note-pill" style="border-color:var(--solar);margin-top:8px">
      <b>Risk & Position Sizing:</b><br>
      ${(rb.riskRules||[]).map(x=>`‚Ä¢ ${x}`).join('<br>')}
    </div>

    <div class="note-pill" style="border-color:var(--arc);margin-top:8px">
      <b>Management:</b><br>
      ${(rb.manageRules||[]).map(x=>`‚Ä¢ ${x}`).join('<br>')}
    </div>

    <div style="margin-top:10px" class="note-pill">
      <b>Note:</b> ${r.note}
      <br><span style="color:var(--ink3);font-size:9px;font-family:var(--mono)">
        Tip: You can change account size/risk by editing SETTINGS in code later (I can add an in-app settings screen next).
      </span>
    </div>
  `;
}

/* =========================================================
   HERO + CHIP + CHART ‚Äî patched
========================================================= */
function buildPriceCache(r){
  // BUGFIX: old code computed chg incorrectly.
  const chg = (r.price!=null && r.prevClose!=null) ? (r.price - r.prevClose) : 0;
  const chgPct = (r.prevClose!=null && r.prevClose>0) ? (chg/r.prevClose*100) : (r.chgPct||0);
  const dir = chgPct>0?'up':chgPct<0?'down':'flat';
  return {
    price: fmtPrice(r.price),
    chgText: `${chg>=0?'+':''}${chg.toFixed(2)} (${chgPct>=0?'+':''}${chgPct.toFixed(2)}%)`,
    dir
  };
}

function updateHero(r){
  document.getElementById('heroSym').textContent = r.ticker;
  document.getElementById('heroName').textContent = r.name;
  const tagCls = r.status==='dump'?'htag-dump':r.status==='pass'?'htag-pass':r.status==='watch'?'htag-watch':'htag-reject';
  document.getElementById('heroTags').innerHTML = `<span class="htag ${tagCls}">${r.statusLabel}</span><span class="htag htag-custom">${r.exchange}</span>`;
  document.getElementById('hs-score').textContent = `${r.score}/115`;
  document.getElementById('hs-score').className = 'hstat-val '+(r.score>=82?'up':r.score>=68?'warn':'down');
  document.getElementById('hs-vol').textContent = `${r.volRatio?.toFixed(1)}√ó`;
  document.getElementById('hs-vol').className = 'hstat-val '+(r.volRatio>=3?'up':r.volRatio>=1.8?'warn':'down');
  document.getElementById('hs-status').textContent = r.statusLabel;
  document.getElementById('hs-status').className = 'hstat-val '+(r.status==='pass'?'up':r.status==='watch'?'warn':'down');
  document.getElementById('hs-float').textContent = r.marketCap ? `$${fmtNum(r.marketCap)}` : r.exchange;

  const pc = buildPriceCache(r);
  priceCache[r.ticker] = pc;
  document.getElementById('heroPrice').textContent = pc.price;
  document.getElementById('heroChg').textContent = pc.chgText;
  document.getElementById('heroChg').className = 'hero-chg '+pc.dir;
}

/* =========================================================
   CHART (TradingView) ‚Äî supports global suffixes already
========================================================= */
function loadChart(sym, tf){
  const wrap = document.getElementById('chartWrap');
  const loader = document.getElementById('chartLoader');
  loader.style.display = 'flex';
  const old = wrap.querySelector('iframe');
  if(old) old.remove();

  const s = KNOWN[sym] || scannedTickers[sym];
  // Attempt exchange mapping for suffix symbols
  const exchGuess = (s?.exchange && s.exchange!=='US') ? s.exchange : guessExchange(sym, s?.exchange);

  const iframe = document.createElement('iframe');
  iframe.src = `https://s.tradingview.com/widgetembed/?frameElementId=tv_${sym}&symbol=${encodeURIComponent(exchGuess)}%3A${encodeURIComponent(sym)}&interval=${tf}&hidesidetoolbar=0&hidetoptoolbar=0&symboledit=0&saveimage=0&toolbarbg=070c14&studies=RSI%40tv-basicstudies%2CMASimple%40tv-basicstudies%2CVWAP%40tv-basicstudies%2CVolume%40tv-basicstudies&theme=dark&style=1&timezone=${encodeURIComponent(CFG.TZ)}&withdateranges=1&showpopupbutton=0&locale=en`;
  iframe.allowTransparency = true; iframe.scrolling = 'no'; iframe.frameBorder = '0'; iframe.allow = 'fullscreen';
  iframe.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;border:none;opacity:0;transition:opacity 0.4s';
  iframe.onload = () => { iframe.style.opacity='1'; loader.style.display='none'; };
  setTimeout(()=>{ loader.style.display='none'; iframe.style.opacity='1'; }, 4500);
  wrap.appendChild(iframe);
}

function guessExchange(sym, fallback){
  // TradingView uses symbols like TSX:SHOP, ASX:BHP, LSE:VOD, etc.
  // Yahoo symbols often have suffixes; we map a few common ones.
  if(fallback && typeof fallback === 'string' && fallback.length<=8) return fallback;
  if(sym.endsWith(".TO")) return "TSX";
  if(sym.endsWith(".V")) return "TSXV";
  if(sym.endsWith(".AX")) return "ASX";
  if(sym.endsWith(".L")) return "LSE";
  if(sym.endsWith(".DE")) return "XETR";
  if(sym.endsWith(".PA")) return "EURONEXT";
  if(sym.endsWith(".AS")) return "EURONEXT";
  if(sym.endsWith(".MI")) return "MIL";
  if(sym.endsWith(".ST")) return "OMXSTO";
  if(sym.endsWith(".HE")) return "OMXHEX";
  if(sym.endsWith(".CO")) return "OMXCOP";
  if(sym.endsWith(".OL")) return "OSL";
  // Default US
  return "NASDAQ";
}

/* =========================================================
   CHIP MANAGEMENT
========================================================= */
function addChip(sym, status, score){
  if(document.getElementById(`chip-${sym}`)){ updateChip(sym,status,score); return; }
  const strip = document.getElementById('strip');
  const d = document.createElement('div');
  d.className = `chip s-${status}`;
  d.id = `chip-${sym}`;
  d.onclick = () => loadTicker(sym);
  d.innerHTML = `<span class="ch-sym">${sym}</span><span class="ch-badge cb-${status}">${score}</span>`;
  strip.appendChild(d);
  strip.scrollLeft = strip.scrollWidth;
}
function updateChip(sym, status, score){
  const chip = document.getElementById(`chip-${sym}`);
  if(!chip){ addChip(sym,status,score); return; }
  chip.className = `chip s-${status}`;
  chip.innerHTML = `<span class="ch-sym">${sym}</span><span class="ch-badge cb-${status}">${score}</span>`;
}

/* =========================================================
   LOAD TICKER / SCAN
========================================================= */
async function scanTicker(sym){
  if(!sym) return;
  sym = sym.toUpperCase().trim();
  if(!sym) return;

  document.getElementById('searchInput').value = '';
  document.querySelectorAll('.chip').forEach(c=>c.style.opacity='1');

  // Known instantly
  if(KNOWN[sym]){ loadTicker(sym); return; }

  addChip(sym, 'loading', '...');
  goPage('chart');

  // Hero scanning
  document.getElementById('heroSym').textContent = sym;
  document.getElementById('heroName').textContent = 'Scanning live data...';
  document.getElementById('heroTags').innerHTML = '<span class="htag htag-scanning">‚è≥ SCANNING</span>';
  document.getElementById('heroPrice').textContent = '‚Äî';
  document.getElementById('heroChg').textContent = '‚Äî';
  document.getElementById('heroChg').className = 'hero-chg flat';
  document.getElementById('hs-score').textContent = '...';
  document.getElementById('hs-vol').textContent = '...';
  document.getElementById('hs-status').textContent = 'SCANNING';
  document.getElementById('hs-float').textContent = '...';
  document.getElementById('loaderSym').textContent = sym;
  document.getElementById('loaderSub').textContent = 'FETCHING LIVE DATA';
  loadChart(sym, currentTF);

  // progress bar
  const prog = document.getElementById('scanProgress');
  const fill = document.getElementById('scanFill');
  prog.style.display = 'block'; fill.style.width='0%';
  setTimeout(()=>fill.style.width='40%', 80);
  setTimeout(()=>fill.style.width='75%', 520);

  // skeletons
  ['dp-score','dp-indic','dp-flags','dp-plan'].forEach(id => {
    document.getElementById(id).innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="skel" style="height:14px;width:60%"></div>
        <div class="skel" style="height:4px;width:100%"></div>
        <div class="skel" style="height:14px;width:80%"></div>
        <div class="skel" style="height:4px;width:70%"></div>
        <div class="skel" style="height:14px;width:55%"></div>
        <div class="skel" style="height:4px;width:90%"></div>
      </div>`;
  });

  try{
    const result = await liveScore(sym);

    fill.style.width = '100%';
    setTimeout(()=>{ prog.style.display='none'; fill.style.width='0%'; }, 450);

    if(!result){
      document.getElementById('heroName').textContent = sym + ' ‚Äî Not found';
      document.getElementById('heroTags').innerHTML = '<span class="htag htag-reject">NOT FOUND</span>';
      ['dp-score','dp-indic','dp-flags','dp-plan'].forEach(id => {
        document.getElementById(id).innerHTML = `<div style="font-size:11px;color:var(--ink2);line-height:1.7">
          <strong style="color:var(--plasma)">Ticker "${sym}" not found.</strong><br>
          Try suffixes for global stocks: <b>.TO</b> (Canada), <b>.AX</b> (Australia), <b>.L</b> (London), <b>.DE</b> (Germany).
        </div>`;
      });
      updateChip(sym,'reject','?');
      return;
    }

    scannedTickers[sym] = result;
    updateChip(sym, result.status, result.score);
    renderLiveScore(result);
    updateHero(result);

    // Alerts
    checkPriceAlerts(sym, result);
    if(result.status === 'dump' && criteria.dump){
      fireToast('danger', `üö® Dump Alert: ${sym}`, result.dumpWarnings[0] || 'Dump risk detected');
      addTriggered(sym, 'dump', result.dumpWarnings.join(' | '));
    } else if(result.score >= 82 && criteria.wt){
      fireToast('alert', `üü¢ Tradeable Setup: ${sym}`, `Score ${result.score}/115 ‚Äî ${result.rulebook?.setup||result.statusLabel}`);
    }

    // Momentum list
    if(result.volRatio >= 3 || result.chgPct >= 10 || result.score >= 68){
      addToMomentum(result);
    }

  }catch(err){
    prog.style.display='none';
    document.getElementById('heroName').textContent = 'Error fetching data for ' + sym;
    document.getElementById('heroTags').innerHTML = '<span class="htag htag-reject">ERROR</span>';
    ['dp-score','dp-indic','dp-flags','dp-plan'].forEach(id => {
      document.getElementById(id).innerHTML = `<div style="font-size:11px;color:var(--ink2)">Network error. Try again or switch proxy mode in code (SETTINGS.useProxy).</div>`;
    });
    updateChip(sym,'reject','!');
  }
}

function loadTicker(sym){
  sym = sym.toUpperCase().trim();
  if(!sym) return;
  currentTicker = sym;

  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  const chip = document.getElementById(`chip-${sym}`);
  if(chip) chip.classList.add('active');

  document.querySelectorAll('.scard').forEach(c=>c.classList.remove('selected'));
  const sc = document.getElementById(`scard-${sym}`);
  if(sc) sc.classList.add('selected');

  const stock = KNOWN[sym] || scannedTickers[sym];
  if(stock){
    updateHero(stock);
    if(KNOWN[sym]){
      // If your KNOWN items don‚Äôt have rulebook, just show their note.
      document.getElementById('dp-score').innerHTML = `<div style="color:var(--ink2);font-size:11px;line-height:1.7">This is a demo KNOWN item. Scan a live ticker for rulebook output.</div>`;
      document.getElementById('dp-indic').innerHTML = `<div style="color:var(--ink2);font-size:11px;line-height:1.7">Scan a live ticker for ATR/VWAP/liquidity scoring.</div>`;
      document.getElementById('dp-flags').innerHTML = `<div style="color:var(--ink2);font-size:11px;line-height:1.7">Scan a live ticker for checklist & rules.</div>`;
      document.getElementById('dp-plan').innerHTML = `<div style="color:var(--ink2);font-size:11px;line-height:1.7">${stock.note||'‚Äî'}</div>`;
    } else {
      renderLiveScore(stock);
    }
  } else {
    // Trigger live scan for unknown
    scanTicker(sym);
    return;
  }

  loadChart(sym, currentTF);
  goPage('chart');
}

/* =========================================================
   MOMENTUM SCAN (fixed)
========================================================= */
async function runMomentumScan(){
  const dot = document.getElementById('scanDot');
  const txt = document.getElementById('scanStatusTxt');
  if(dot) dot.className = 'scan-dot';
  if(txt) txt.textContent = 'SCANNING...';

  const toScan = [...Object.keys(KNOWN)];
  redditData.slice(0,12).forEach(r=>{ if(r.ticker && !toScan.includes(r.ticker)) toScan.push(r.ticker); });

  const results = [];
  for(const sym of toScan.slice(0, CFG.SCAN_MAX)){
    try{
      const existing = scannedTickers[sym];
      if(existing && existing.price){ results.push(existing); }
      else{
        const r = await liveScore(sym);
        if(r){ scannedTickers[sym]=r; results.push(r); }
      }
      await sleep(220);
    }catch(e){}
  }

  momentumTickers = results.filter(r=>r && r.price!=null)
    .sort((a,b)=> (b.volRatio||0) - (a.volRatio||0));

  renderMomentum();

  if(dot) dot.className = 'scan-dot active';
  if(txt) txt.textContent = `UPDATED ${new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}`;

  const newHC = momentumTickers.filter(r=>r.score>=82 && r.status!=='dump');
  if(newHC.length){
    updateBadge('momBadge', newHC.length);
    if(criteria.wt){
      fireToast('alert', `‚ö° ${newHC.length} Tradeable Setup${newHC.length>1?'s':''}`, newHC.map(r=>r.ticker).slice(0,6).join(', ') + (newHC.length>6?'‚Ä¶':''));
    }
  }
}

function addToMomentum(result){
  const idx = momentumTickers.findIndex(t=>t.ticker===result.ticker);
  if(idx>=0) momentumTickers[idx]=result;
  else momentumTickers.unshift(result);
  momentumTickers.sort((a,b)=> (b.volRatio||0)-(a.volRatio||0));
  if(document.getElementById('momentumPage')?.classList.contains('active')) renderMomentum();
}

function setMomFilter(f, el){
  momFilter=f;
  document.querySelectorAll('.rchip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderMomentum();
}

function renderMomentum(){
  const list = document.getElementById('momentumList');
  if(!list) return;
  let data = [...momentumTickers];

  if(momFilter === 'vol3x') data = data.filter(r=>r.volRatio>=3);
  else if(momFilter === 'gap') data = data.filter(r=>r.open && r.prevClose && (r.open-r.prevClose)/r.prevClose*100 >= 5);
  else if(momFilter === 'wt') data = data.filter(r=>r.score>=68 && r.status!=='dump');
  else if(momFilter === 'dump') data = data.filter(r=>r.status==='dump');

  if(!data.length){
    list.innerHTML = `<div class="no-setup"><div class="nsi">üî≠</div><div class="nst">NO RESULTS</div><div class="nsd">No tickers match this filter right now.</div></div>`;
    return;
  }

  list.innerHTML = data.map(r=>{
    const volBadgeCls = r.volRatio>=10?'vb-fire':r.volRatio>=3?'vb-hot':'vb-norm';
    const cardType = r.status==='dump'?'danger':r.score>=82?'':r.score>=68?'warning':'';
    const chgCol = r.chgPct>=0?'up':'down';
    const volPct = Math.min(100, (r.volRatio||0)/20*100);
    const scorePct = Math.round(r.score/115*100);
    const chgPct2 = Math.min(100, Math.abs(r.chgPct||0)/50*100);
    const wtPass = r.wtFlags?.filter(f=>f.pass).length||0;
    const wtTotal = r.wtFlags?.length||1;

    return `
      <div class="mom-card ${cardType}" onclick="loadTicker('${r.ticker}')">
        <div class="mom-top">
          <div class="mom-sym">${r.ticker}</div>
          <div class="mom-chg ${chgCol}">${r.chgPct>=0?'+':''}${r.chgPct.toFixed(2)}%</div>
          <div class="mom-vol-badge ${volBadgeCls}">${(r.volRatio||0).toFixed(1)}√ó VOL</div>
        </div>
        <div class="mom-bars">
          <div class="mbar-row"><div class="mbar-lbl">Score</div><div class="mbar-track"><div class="mbar-fill" style="width:${scorePct}%;background:${r.score>=82?'var(--acid)':r.score>=68?'var(--solar)':'var(--plasma)'}"></div></div><div class="mbar-val" style="color:${r.score>=82?'var(--acid)':r.score>=68?'var(--solar)':'var(--plasma)'}">${r.score}/115</div></div>
          <div class="mbar-row"><div class="mbar-lbl">Volume</div><div class="mbar-track"><div class="mbar-fill" style="width:${volPct}%;background:var(--nova)"></div></div><div class="mbar-val" style="color:var(--nova)">${(r.volRatio||0).toFixed(1)}√ó</div></div>
          <div class="mbar-row"><div class="mbar-lbl">Move</div><div class="mbar-track"><div class="mbar-fill" style="width:${chgPct2}%;background:${r.chgPct>=0?'var(--acid)':'var(--plasma)'}"></div></div><div class="mbar-val" style="color:${r.chgPct>=0?'var(--acid)':'var(--plasma)'}">${r.chgPct>=0?'+':''}${r.chgPct.toFixed(1)}%</div></div>
        </div>
        <div class="mom-meta">
          <span class="mom-meta-item">${fmtPrice(r.price)}</span>
          <span class="mom-meta-item">${(r.name||r.ticker).split(' ').slice(0,3).join(' ')}</span>
          ${wtPass>=4?`<span class="mom-WT">CHK ${wtPass}/${wtTotal}</span>`:''}
          ${r.score>=82 && r.status!=='dump'?`<span class="sc-pill pill-pass">üü¢ TRADE</span>`:''}
          ${r.status==='dump'?`<span class="sc-pill pill-dump">üö® DUMP</span>`:''}
        </div>
      </div>`;
  }).join('');
}

/* =========================================================
   ALERTS (patched)
========================================================= */
function addAlert(){
  const ticker = document.getElementById('alertTicker').value.trim().toUpperCase();
  const type = document.getElementById('alertType').value;
  const thresh = document.getElementById('alertThresh').value.trim();
  if(!ticker){ fireToast('warning','‚ö† Enter Ticker','Please enter a ticker symbol'); return; }

  const labels = {vol3x:'Vol ‚â• 3√ó average',priceup:'Price up %',pricedown:'Price drop %',score80:'Score ‚â• 82',dump:'Dump signal',mention:'Reddit spike'};
  alerts.unshift({id:Date.now(),ticker,type,typeLabel:labels[type],threshold:thresh||'any',createdAt:new Date().toISOString(),status:'pending'});
  saveData(); buildAlerts();
  document.getElementById('alertTicker').value=''; document.getElementById('alertThresh').value='';
  fireToast('alert',`‚úÖ Alert Set: ${ticker}`,`Watching for ${labels[type]}`);
}
function deleteAlert(id){ alerts = alerts.filter(a=>a.id!==id); saveData(); buildAlerts(); }
function toggleCrit(name, el){
  criteria[name] = !criteria[name];
  el.textContent = criteria[name] ? 'ON' : 'OFF';
  el.className = 'tog ' + (criteria[name] ? 'on' : 'off');
}

function buildAlerts(){
  const pend = alerts.filter(a=>a.status==='pending');
  document.getElementById('cnt-alerts').textContent = pend.length;
  document.getElementById('cnt-trig').textContent = triggered.length;
  updateBadge('alertBadge', triggered.filter(t=>!t.seen).length);

  document.getElementById('alertsList').innerHTML = pend.length ? pend.map(a=>`
    <div class="alert-item">
      <div class="ai-icon aii-pend">‚è≥</div>
      <div class="ai-info">
        <div class="ai-ticker">${a.ticker}</div>
        <div class="ai-cond">${a.typeLabel}${a.threshold&&a.threshold!=='any'?' ‚Äî '+a.threshold:''}</div>
        <div class="ai-time">${new Date(a.createdAt).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
      </div>
      <button class="ai-del" onclick="deleteAlert(${a.id})">‚úï</button>
    </div>`).join('')
  : `<div class="no-setup"><div class="nsi">üîî</div><div class="nst">NO ACTIVE ALERTS</div><div class="nsd">Add a ticker above to start watching.</div></div>`;

  document.getElementById('triggeredList').innerHTML = triggered.length ? triggered.slice(0,15).map(t=>`
    <div class="alert-item">
      <div class="ai-icon ${t.type==='dump'?'aii-dump':'aii-fire'}">${t.type==='dump'?'üö®':'‚úÖ'}</div>
      <div class="ai-info">
        <div class="ai-ticker">${t.ticker}</div>
        <div class="ai-cond">${t.message}</div>
        <div class="ai-time">${new Date(t.firedAt).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
      </div>
    </div>`).join('')
  : `<div style="padding:12px;font-size:11px;color:var(--ink3);text-align:center;font-family:var(--mono)">No alerts triggered yet</div>`;
}

function checkPriceAlerts(sym, r){
  alerts.filter(a=>a.ticker===sym && a.status==='pending').forEach(a=>{
    let fire=false, msg='';
    const thresh = parseFloat(a.threshold)||5;
    if(a.type==='priceup' && r.chgPct>=thresh){ fire=true; msg=`Up ${r.chgPct.toFixed(1)}% (target +${thresh}%)`; }
    if(a.type==='pricedown' && r.chgPct<=-thresh){ fire=true; msg=`Down ${Math.abs(r.chgPct).toFixed(1)}%`; }
    if(a.type==='vol3x' && r.volRatio>=3){ fire=true; msg=`RelVol ${r.volRatio.toFixed(1)}√ó ‚Äî in play`; }
    if(a.type==='score80' && r.score>=82){ fire=true; msg=`Score ${r.score}/115 ‚Äî ${r.rulebook?.setup||'TRADEABLE'}`; }
    if(a.type==='dump' && r.status==='dump'){ fire=true; msg=r.dumpWarnings[0]||'Dump risk'; }

    if(fire){
      a.status='fired';
      addTriggered(sym, a.type, msg);
      fireToast('alert',`üîî Alert: ${sym}`,msg);
      saveData();
    }
  });
}

function checkRedditAlerts(data){
  data.forEach(d=>{
    const old = d.mentions_24h_ago;
    const spike = old>0 ? (d.mentions-old)/old*100 : null;

    if(spike && spike > 500 && criteria.mention){
      fireToast('warning', `üì° Reddit Spike`, `${d.ticker} mentions +${Math.round(spike)}%`);
    }

    alerts.filter(a=>a.ticker===d.ticker && a.type==='mention' && a.status==='pending').forEach(a=>{
      const thresh = parseFloat(a.threshold)||500;
      if(spike && spike>=thresh){
        a.status='fired';
        addTriggered(d.ticker,'mention',`Reddit spike +${Math.round(spike)}%`);
        fireToast('alert',`üîî ${d.ticker}`,`Mention spike +${Math.round(spike)}%`);
        saveData();
      }
    });
  });
}

function addTriggered(ticker,type,message){
  // avoid duplicates within 60 minutes
  if(triggered.find(t=>t.ticker===ticker && t.type===type && (Date.now()-new Date(t.firedAt).getTime())<3600000)) return;
  triggered.unshift({ticker,type,message,firedAt:new Date().toISOString(),seen:false});
  if(triggered.length>50) triggered.pop();
  saveData(); buildAlerts();
}

function updateBadge(id,n){
  const el = document.getElementById(id);
  if(!el) return;
  if(n>0){ el.textContent = n>9?'9+':n; el.style.display='flex'; }
  else el.style.display='none';
}

/* =========================================================
   REDDIT RENDER (same as yours, trimmed)
========================================================= */
function renderReddit(data){
  const list = document.getElementById('redditList');
  if(!list) return;
  const max = Math.max(...data.map(d=>d.mentions||0), 1);

  list.innerHTML = data.slice(0,30).map((d,i)=>{
    const spike = d.mentions_24h_ago>0 ? Math.round((d.mentions-d.mentions_24h_ago)/d.mentions_24h_ago*100) : null;
    const spikeCls = spike===null?'rs-cool':spike>200?'rs-fire':spike>50?'rs-hot':'rs-cool';
    const spikeLabel = spike===null?'NEW':spike>0?`+${spike}%`:`${spike}%`;
    const pct = Math.round((d.mentions||0)/max*100);

    return `
      <div class="reddit-item" onclick="scanTicker('${d.ticker}')">
        <div class="ri-top">
          <span class="ri-rank">#${i+1}</span>
          <span class="ri-sym">${d.ticker}</span>
          <span class="ri-spike ${spikeCls}">${spikeLabel}</span>
          <span class="ri-cnt">${d.mentions||0}</span>
        </div>
        <div class="ri-bar"><div class="ri-bar-fill" style="width:${pct}%"></div></div>
        <div class="ri-meta"><span class="ri-meta-item">${d.name||d.ticker}</span><span class="ri-meta-item">‚Üë${d.upvotes||0}</span>${d.mentions_24h_ago?`<span class="ri-meta-item">24h: ${d.mentions_24h_ago}</span>`:''}</div>
      </div>`;
  }).join('');
}

/* =========================================================
   SCANNER LISTS (KNOWN only) ‚Äî keep minimal
========================================================= */
function buildScannerLists(){
  const all = Object.entries(KNOWN).map(([k,v])=>({ticker:k,...v}));
  const dumps = all.filter(s=>s.status==='dump');
  const hc = all.filter(s=>s.score>=82 && s.status!=='dump');
  const watch = all.filter(s=>s.score>=68 && s.score<82 && s.status!=='dump');
  const rej = all.filter(s=>s.score<68 && s.status!=='dump');

  document.getElementById('cnt-dump').textContent = dumps.length;
  document.getElementById('cnt-hc').textContent = hc.length;
  document.getElementById('cnt-watch').textContent = watch.length;
  document.getElementById('cnt-rej').textContent = rej.length;

  document.getElementById('list-dump').innerHTML = dumps.map(scanCard).join('');
  if(hc.length) document.getElementById('list-hc').innerHTML = hc.map(scanCard).join('');
  if(watch.length) document.getElementById('list-watch').innerHTML = watch.map(scanCard).join('');
  document.getElementById('list-rej').innerHTML = rej.map(scanCard).join('');
}
function scanCard(s){
  const scoreCol = s.status==='dump'?'color:var(--nova)':s.score>=82?'color:var(--acid)':s.score>=68?'color:var(--solar)':'color:var(--plasma)';
  return `
    <div class="scard ${s.status}" id="scard-${s.ticker}" onclick="loadTicker('${s.ticker}')">
      <div class="sc-left">
        <div class="sc-sym2">${s.ticker}</div>
        <div class="sc-name2">${s.name}</div>
        <div class="sc-pills">
          <span class="sc-pill pill-${s.status}">${s.statusLabel}</span>
        </div>
      </div>
      <div class="sc-right">
        <div class="sc-score-num" style="${scoreCol}">${s.score}</div>
        <div class="sc-pts">/115 pts</div>
      </div>
    </div>`;
}

/* =========================================================
   SEARCH + TF + NAV + TOAST
========================================================= */
function onSearch(val){
  val = (val||'').toUpperCase();
  if(val.length>=1){
    document.querySelectorAll('.chip').forEach(c=>{
      const s=c.id.replace('chip-','');
      c.style.opacity = s.startsWith(val) ? '1' : '0.3';
    });
  } else {
    document.querySelectorAll('.chip').forEach(c=>c.style.opacity='1');
  }
}
function setTF(tf, btn){
  currentTF = tf;
  document.querySelectorAll('.tf-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(currentTicker) loadChart(currentTicker, tf);
}
function goPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(`${name}Page`).classList.add('active');
  document.getElementById(`nav-${name}`).classList.add('active');

  if(name==='alerts'){
    triggered.forEach(t=>t.seen=true);
    saveData();
    updateBadge('alertBadge',0);
    buildAlerts();
  }
  if(name==='momentum'){
    updateBadge('momBadge',0);
    if(!momentumTickers.length) runMomentumScan();
  }
}
function setDrawer(name, btn){
  document.querySelectorAll('.dtab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.dpanel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(`dp-${name}`).classList.add('active');
}
function fireToast(type,title,msg){
  const icons={alert:'‚úÖ',warning:'‚ö†Ô∏è',danger:'üö®'};
  const c=document.getElementById('toasts');
  const t=document.createElement('div');
  t.className=`toast ${type}`;
  t.innerHTML=`<div class="t-ico">${icons[type]||'‚Ñπ'}</div><div class="t-body"><div class="t-title">${title}</div><div class="t-msg">${msg}</div></div><button class="t-x" onclick="this.parentElement.remove()">‚úï</button>`;
  c.appendChild(t);
  setTimeout(()=>{t.style.animation='none';t.style.opacity='0';t.style.transform='translateY(-8px)';t.style.transition='all 0.25s';setTimeout(()=>t.remove(),250);},5000);
}

/* =========================================================
   BUILD STRIP + INIT
========================================================= */
function buildStrip(){
  const strip = document.getElementById('strip');
  strip.innerHTML = Object.entries(KNOWN).map(([k,s])=>`
    <div class="chip s-${s.status}" id="chip-${k}" onclick="loadTicker('${k}')">
      <span class="ch-sym">${k}</span>
      <span class="ch-badge cb-${s.status}">${s.score}</span>
    </div>`).join('');
}

function init(){
  // expose functions for inline HTML handlers
  window.onSearch = onSearch;
  window.scanTicker = scanTicker;
  window.loadTicker = loadTicker;
  window.goPage = goPage;
  window.setTF = setTF;
  window.setDrawer = setDrawer;
  window.fetchReddit = fetchReddit;
  window.addAlert = addAlert;
  window.toggleCrit = toggleCrit;
  window.setMomFilter = setMomFilter;

  buildStrip();
  buildScannerLists();
  buildAlerts();
  fetchReddit();

  // Start on demo if you want
  setTimeout(()=>{ if(KNOWN.OLB) loadTicker('OLB'); }, 500);

  // recurring momentum scan
  scanIntervalId = setInterval(runMomentumScan, 90000);
}

init();
</script>
