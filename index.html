<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Magnify Scanner (Stable)</title>
  <style>
    :root{
      --bg:#060915;--panel:#0c1224;--card:#0f1933;--edge:#1c2b4a;
      --txt:#e8f0ff;--mut:#8aa1c7;--bad:#ff3b6b;--ok:#00ff88;--warn:#ffbf3b;--info:#5aa2ff;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --r:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .top{position:sticky;top:0;z-index:20;background:rgba(6,9,21,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--edge);padding:12px}
    .title{font-weight:800;letter-spacing:.06em;color:var(--ok);font-size:16px}
    .sub{color:var(--mut);font-family:var(--mono);font-size:11px;margin-top:2px}
    .wrap{max-width:520px;margin:0 auto}
    .row{display:flex;gap:8px;margin-top:10px}
    input,select,button{border-radius:10px;border:1px solid var(--edge);background:var(--panel);color:var(--txt);padding:10px 12px;font-size:14px}
    input{flex:1;font-family:var(--mono);text-transform:uppercase}
    select{width:120px}
    button{background:var(--ok);border:none;color:#00140a;font-weight:900;letter-spacing:.06em}
    button:active{transform:scale(.98)}
    .grid{display:grid;gap:10px;padding:12px}
    .card{background:var(--card);border:1px solid var(--edge);border-radius:var(--r);padding:12px}
    .kvs{display:grid;grid-template-columns:1fr auto;gap:8px 10px;font-family:var(--mono);font-size:12px}
    .lbl{color:var(--mut)}
    .val{font-weight:700}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--edge);background:rgba(255,255,255,.03);
      border-radius:999px;padding:6px 10px;font-family:var(--mono);font-size:11px;margin:6px 6px 0 0}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)} .info{color:var(--info)}
    .hr{height:1px;background:var(--edge);margin:10px 0}
    .small{color:var(--mut);font-size:12px;line-height:1.5}
    .errbox{white-space:pre-wrap;font-family:var(--mono);font-size:11px;color:#ffd2dc;background:rgba(255,59,107,.08);
      border:1px solid rgba(255,59,107,.3);border-radius:10px;padding:10px}
    .footer{padding:14px 12px;color:var(--mut);font-size:11px;text-align:center}
    a{color:var(--info);text-decoration:none}
  </style>
</head>
<body>
  <div class="top">
    <div class="wrap">
      <div class="title">MAGNIFY SCANNER</div>
      <div class="sub">Stable GitHub Pages build • Multi-proxy Yahoo fetch • Intl suffix auto-try</div>
      <div class="row">
        <input id="ticker" placeholder="Try: AAPL, SHOP.TO, BHP.AX, SAP.DE, VOD.L" maxlength="16" />
        <select id="region">
          <option value="auto" selected>AUTO</option>
          <option value="us">US</option>
          <option value="ca">CA</option>
          <option value="au">AU</option>
          <option value="eu">EU</option>
        </select>
        <button id="scanBtn">SCAN</button>
      </div>
      <div class="small" style="margin-top:8px">
        Tip: Intl stocks often need suffix. This app will auto-try common ones if you choose CA/AU/EU or AUTO.
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid" id="out">
      <div class="card">
        <div class="small">Enter a ticker and tap <b>SCAN</b>. If something fails, you’ll see the exact reason here (not a white page).</div>
      </div>
    </div>
    <div class="footer">
      Educational only. High-risk markets. Data via Yahoo endpoints through public proxies.
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const out = $("out");
  const scanBtn = $("scanBtn");
  const inp = $("ticker");
  const regionSel = $("region");

  // ===== Proxy fallbacks =====
  // Direct Yahoo calls are usually blocked by CORS on GitHub Pages.
  // So we try multiple public "fetch-any-url" proxies.
  const PROXIES = [
    (url)=>"https://api.allorigins.win/raw?url="+encodeURIComponent(url),
    (url)=>"https://api.codetabs.com/v1/proxy?quest="+encodeURIComponent(url),
    (url)=>"https://r.jina.ai/http://"+url.replace(/^https?:\/\//,''),
  ];

  function money(n){
    if(n==null || isNaN(n)) return "N/A";
    const abs=Math.abs(n);
    if(abs>=1e12) return (n/1e12).toFixed(2)+"T";
    if(abs>=1e9) return (n/1e9).toFixed(2)+"B";
    if(abs>=1e6) return (n/1e6).toFixed(2)+"M";
    if(abs>=1e3) return (n/1e3).toFixed(2)+"K";
    return String(n);
  }
  function priceFmt(p){
    if(p==null || isNaN(p)) return "N/A";
    if(p<1) return "$"+p.toFixed(4);
    if(p<10) return "$"+p.toFixed(3);
    return "$"+p.toFixed(2);
  }

  function card(html){ return `<div class="card">${html}</div>`; }
  function pill(text, cls){ return `<span class="pill ${cls||''}">${text}</span>`; }

  function setLoading(sym){
    out.innerHTML = card(`
      <div style="font-family:var(--mono);font-size:12px;color:var(--mut)">Scanning <b class="info">${sym}</b>…</div>
      <div class="small" style="margin-top:8px">Trying multiple feeds/proxies. If it fails you’ll see why.</div>
    `);
  }

  function showError(title, details){
    out.innerHTML = card(`
      <div style="font-weight:800;color:var(--bad);margin-bottom:6px">${title}</div>
      <div class="errbox">${details}</div>
      <div class="small" style="margin-top:10px">
        Quick fixes:
        <ul>
          <li>Try ticker with suffix: <b>SHOP.TO</b>, <b>BHP.AX</b>, <b>SAP.DE</b>, <b>VOD.L</b></li>
          <li>Switch Region dropdown from AUTO to the correct region</li>
          <li>Reload with cache-bust: add <b>?v=123</b> to the URL</li>
        </ul>
      </div>
    `);
  }

  function buildSymbolCandidates(raw, region){
    const sym = raw.toUpperCase().trim();
    if(!sym) return [];
    // If user already provided suffix (contains dot), keep it first.
    const hasSuffix = sym.includes(".");
    const base = sym;

    const CA = [".TO",".V",".CN"];
    const AU = [".AX"];
    const EU = [".L",".DE",".PA",".AS",".SW",".MI",".ST",".HE",".CO",".OL",".IR",".BR",".MC"];

    let list = [];
    if(hasSuffix){
      list.push(sym);
      // also try raw without suffix just in case
      list.push(sym.split(".")[0]);
      return [...new Set(list)];
    }

    if(region === "us"){
      list.push(base);
    } else if(region === "ca"){
      list.push(base, ...CA.map(s=>base+s));
    } else if(region === "au"){
      list.push(base, ...AU.map(s=>base+s));
    } else if(region === "eu"){
      list.push(base, ...EU.map(s=>base+s));
    } else { // auto
      // Start with US, then CA/AU/EU common suffixes
      list.push(base);
      list.push(...CA.map(s=>base+s));
      list.push(...AU.map(s=>base+s));
      list.push(...EU.map(s=>base+s));
    }
    return [...new Set(list)];
  }

  async function fetchYahooQuote(symbol){
    const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbol)}`;

    // Try each proxy until one returns parsable JSON with a quote.
    let lastErr = "";
    for(const proxy of PROXIES){
      const proxied = proxy(url);
      try{
        const res = await fetch(proxied, {cache:"no-store"});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();

        // r.jina.ai returns raw content but sometimes includes extra wrapping or text.
        // Try to find JSON boundary.
        let jsonText = text.trim();
        const firstBrace = jsonText.indexOf("{");
        const lastBrace = jsonText.lastIndexOf("}");
        if(firstBrace >= 0 && lastBrace > firstBrace){
          jsonText = jsonText.slice(firstBrace, lastBrace+1);
        }

        const data = JSON.parse(jsonText);
        const q = data?.quoteResponse?.result?.[0];
        if(q) return {q, via: proxied};
        lastErr = `No quote in response via proxy: ${proxied}\nRaw head: ${text.slice(0,220)}`;
      } catch(e){
        lastErr = `Proxy failed: ${proxied}\n${String(e)}\n`;
      }
    }
    throw new Error(lastErr || "All proxies failed.");
  }

  function computeScore(q){
    const price = q.regularMarketPrice;
    const prev = q.regularMarketPreviousClose;
    const chgPct = (price && prev) ? ((price-prev)/prev*100) : 0;
    const vol = q.regularMarketVolume || 0;
    const avgVol = q.averageDailyVolume3Month || q.averageDailyVolume10Day || 1;
    const volRatio = avgVol ? (vol/avgVol) : 0;
    const dollarVol = (price||0) * vol;
    const mcap = q.marketCap || null;
    const mcapB = mcap ? (mcap/1e9) : null;

    // Your preferences:
    const priceOK = price>=0.2 && price<=50;
    const mcapOK = !mcapB || mcapB<=5; // you told me: exclude > $5B
    // Liquidity threshold (adjustable):
    const liquid = dollarVol >= 300000; // $300k/day minimum

    // Score: 0..100
    // This is intentionally simple + robust. We can later make it more “scientific” safely.
    let score = 0;

    // Liquidity & attention
    if(dollarVol >= 2000000) score += 25;
    else if(dollarVol >= 1000000) score += 20;
    else if(dollarVol >= 300000) score += 12;
    else score += 2;

    // Volume surge
    if(volRatio >= 5) score += 25;
    else if(volRatio >= 3) score += 18;
    else if(volRatio >= 2) score += 10;
    else score += 2;

    // Momentum (but penalize “too extended”)
    if(chgPct >= 20) score += 12;
    else if(chgPct >= 8) score += 10;
    else if(chgPct >= 3) score += 6;
    else if(chgPct <= -12) score -= 6;

    // Constraints
    if(priceOK) score += 10; else score -= 15;
    if(mcapOK) score += 8; else score -= 50; // hard push-out

    // Soft risk flags
    if(!liquid) score -= 15;

    // Clamp
    score = Math.max(0, Math.min(100, Math.round(score)));

    // Status
    let status = "REJECT";
    if(score >= 80) status = "HIGH CONVICTION";
    else if(score >= 65) status = "WATCH";

    return {score,status,chgPct,volRatio,dollarVol,priceOK,mcapOK,liquid};
  }

  function makeRulebook(m){
    // Very practical rules; not pretending to be “guaranteed edge”.
    // Designed for your style (momentum + filters).
    let entry = "AVOID";
    let stop = "—";
    let target = "—";
    let notes = [];

    if(m.status === "HIGH CONVICTION"){
      entry = "ONLY if price holds VWAP + breaks HOD with rising volume";
      stop  = "Hard stop: below VWAP OR -8% from entry (whichever hits first)";
      target= "Scale: +10% (trim), +20% (trim), runner with trailing stop";
      notes.push("Skip if spreads are huge or prints are erratic.");
      notes.push("No averaging down. One shot only.");
      notes.push("Max risk per trade: 0.5–1.0% of account.");
    } else if(m.status === "WATCH"){
      entry = "Wait: volume ≥3× AND break of key resistance (HOD / prior day high)";
      stop  = "Below breakout level or day low";
      target= "+8% to +15% if tape stays strong";
      notes.push("If volume fades, do nothing.");
    } else {
      notes.push("Does not meet minimum: either illiquid, wrong price band, or no real vol surge.");
    }

    // Extra hard filters (your preferences)
    if(!m.priceOK) notes.unshift("FAIL: price not in $0.20–$50 band.");
    if(!m.mcapOK) notes.unshift("FAIL: market cap above $5B (excluded by your rules).");
    if(!m.liquid) notes.unshift("FAIL: liquidity too low for clean entries (DollarVol < $300k).");

    return {entry,stop,target,notes};
  }

  function render(q, meta, usedSymbol, via){
    const price = q.regularMarketPrice;
    const prev = q.regularMarketPreviousClose;
    const chg = (price && prev) ? (price-prev) : null;
    const chgPct = meta.chgPct;

    const col = meta.status==="HIGH CONVICTION" ? "ok" : meta.status==="WATCH" ? "warn" : "bad";
    const rules = makeRulebook(meta);

    out.innerHTML = `
      ${card(`
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
          <div>
            <div style="font-family:var(--mono);font-size:12px;color:var(--mut)">SYMBOL</div>
            <div style="font-size:26px;font-weight:900;letter-spacing:.04em">${usedSymbol}</div>
            <div class="small">${(q.longName || q.shortName || "—")}</div>
            <div style="margin-top:6px">
              ${pill(`${meta.status}`, col)}
              ${pill(`Score ${meta.score}/100`, col)}
              ${pill(`${q.fullExchangeName || q.exchange || "—"}`, "info")}
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-family:var(--mono);font-size:12px;color:var(--mut)">PRICE</div>
            <div style="font-size:22px;font-weight:900">${priceFmt(price)}</div>
            <div style="font-family:var(--mono);font-size:12px" class="${chgPct>=0?'ok':'bad'}">
              ${chgPct>=0?'+':''}${chgPct.toFixed(2)}% ${chg!=null?`(${chg>=0?'+':''}${chg.toFixed(2)})`:''}
            </div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="kvs">
          <div class="lbl">Vol ratio (today vs 3mo avg)</div><div class="val">${meta.volRatio.toFixed(2)}×</div>
          <div class="lbl">Dollar volume (approx)</div><div class="val">$${money(meta.dollarVol)}</div>
          <div class="lbl">Volume</div><div class="val">${money(q.regularMarketVolume||0)}</div>
          <div class="lbl">Avg vol (3mo)</div><div class="val">${money(q.averageDailyVolume3Month||0)}</div>
          <div class="lbl">Market cap</div><div class="val">${q.marketCap?("$"+money(q.marketCap)):"N/A"}</div>
          <div class="lbl">52w range</div><div class="val">${q.fiftyTwoWeekLow?priceFmt(q.fiftyTwoWeekLow):"N/A"} – ${q.fiftyTwoWeekHigh?priceFmt(q.fiftyTwoWeekHigh):"N/A"}</div>
        </div>
        <div class="small" style="margin-top:10px">
          Data source: Yahoo quote via proxy. If values look wrong, rescan.
        </div>
      `)}

      ${card(`
        <div style="font-weight:900;margin-bottom:6px">Trading Rulebook (auto-generated)</div>
        <div class="kvs">
          <div class="lbl">Entry</div><div class="val">${rules.entry}</div>
          <div class="lbl">Stop</div><div class="val">${rules.stop}</div>
          <div class="lbl">Target</div><div class="val">${rules.target}</div>
        </div>
        <div class="hr"></div>
        <div class="small"><b>Hard filters:</b> Price band $0.20–$50 • Market cap ≤ $5B • DollarVol ≥ $300k</div>
        <div style="margin-top:8px" class="small">
          ${rules.notes.map(n=>`• ${n}`).join("<br>")}
        </div>
      `)}

      ${card(`
        <div class="small">
          <b>Debug:</b> succeeded with <span class="info">${via.includes("allorigins")?"allorigins":via.includes("codetabs")?"codetabs":"jina"}</span><br>
          <span class="small">(${via})</span>
        </div>
      `)}
    `;
  }

  async function scan(){
    const raw = inp.value.trim();
    if(!raw){
      showError("No ticker entered", "Enter something like AAPL or SHOP.TO");
      return;
    }

    const region = regionSel.value;
    const candidates = buildSymbolCandidates(raw, region);

    setLoading(candidates[0] || raw);

    let lastError = "";
    for(const sym of candidates){
      try{
        const {q, via} = await fetchYahooQuote(sym);

        // Validate price range existence
        if(q.regularMarketPrice == null){
          lastError = `No price for ${sym}.`;
          continue;
        }

        const meta = computeScore(q);
        render(q, meta, sym, via);
        return;

      } catch(e){
        lastError = `Tried ${sym}\n${String(e)}\n`;
      }
    }
    showError("Scan failed (all attempts)", lastError || "Unknown error");
  }

  scanBtn.addEventListener("click", scan);
  inp.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ scan(); inp.blur(); } });

})();
</script>
</body>
</html>
