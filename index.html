<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Magnify Scanner (Proxy Stable)</title>
  <style>
    :root{
      --bg:#060915; --panel:#0c1224; --panel2:#0a1020;
      --txt:#e8f0ff; --mut:#8aa1c7; --mut2:#5f7396;
      --green:#2cff88; --green2:#00d26a; --red:#ff4d6d; --amber:#ffcc66;
      --stroke:#1b2a4a;
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 30% -10%, #11204a 0%, rgba(6,9,21,0) 60%), var(--bg); color:var(--txt); font-family:var(--sans);}
    a{color:var(--mut); text-decoration:none}
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 36px}
    .top{
      position:sticky; top:0; z-index:9;
      backdrop-filter: blur(10px);
      background:linear-gradient(to bottom, rgba(6,9,21,.92), rgba(6,9,21,.55));
      border-bottom:1px solid rgba(27,42,74,.6);
      padding:14px 0 12px;
      margin:-18px -14px 14px;
    }
    .top .inner{max-width:980px;margin:0 auto;padding:0 14px}
    .brand{font-weight:900; letter-spacing:.06em; color:var(--green); font-size:22px}
    .sub{color:var(--mut); font-size:13px; margin-top:4px; line-height:1.2}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px}
    .input{
      flex:1 1 240px;
      display:flex; align-items:center;
      border:1px solid rgba(27,42,74,.85);
      background:linear-gradient(180deg, rgba(12,18,36,.9), rgba(10,16,32,.9));
      border-radius:18px; padding:10px 12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .input input{
      width:100%; border:0; outline:0; background:transparent;
      color:var(--txt); font-size:18px; letter-spacing:.02em;
    }
    .pill{
      border:1px solid rgba(27,42,74,.85);
      background:linear-gradient(180deg, rgba(12,18,36,.9), rgba(10,16,32,.9));
      border-radius:16px; padding:10px 10px;
      color:var(--txt);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    select{
      border:0; outline:0; background:transparent; color:var(--txt);
      font-size:14px;
    }
    .btn{
      border:0; border-radius:18px;
      padding:12px 16px;
      background:linear-gradient(180deg, var(--green), var(--green2));
      font-weight:900; letter-spacing:.06em;
      color:#061116; font-size:14px;
      box-shadow:0 12px 30px rgba(0,210,106,.25);
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .hint{color:var(--mut2); font-size:12px; margin-top:8px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px}
    @media(min-width:820px){ .grid{grid-template-columns: 1.2fr .8fr} }
    .card{
      border:1px solid rgba(27,42,74,.75);
      background:linear-gradient(180deg, rgba(12,18,36,.85), rgba(10,16,32,.85));
      border-radius:var(--r);
      padding:14px;
      box-shadow:0 18px 50px rgba(0,0,0,.25);
    }
    .card h3{margin:0 0 8px; font-size:14px; color:var(--mut); letter-spacing:.08em; text-transform:uppercase}
    .big{
      font-size:36px; font-weight:900; letter-spacing:.02em; margin:0;
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(27,42,74,.9);
      background:rgba(5,10,20,.6);
      font-size:12px; color:var(--mut);
    }
    .ok{color:var(--green)}
    .bad{color:var(--red)}
    .warn{color:var(--amber)}
    .kv{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .kv .box{
      border:1px solid rgba(27,42,74,.7);
      border-radius:14px;
      padding:10px;
      background:rgba(6,9,21,.35);
    }
    .k{color:var(--mut2); font-size:11px; letter-spacing:.08em; text-transform:uppercase}
    .v{font-family:var(--mono); margin-top:6px; font-size:13px}
    .tabs{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
    .tab{
      border:1px solid rgba(27,42,74,.8);
      background:rgba(6,9,21,.25);
      color:var(--mut);
      padding:8px 10px; border-radius:999px;
      font-size:12px; cursor:pointer;
    }
    .tab.active{color:var(--txt); border-color:rgba(44,255,136,.55); background:rgba(0,210,106,.08)}
    .panel{margin-top:10px; border:1px solid rgba(27,42,74,.7); border-radius:14px; padding:12px; background:rgba(6,9,21,.25)}
    .mono{font-family:var(--mono); font-size:12px; color:var(--mut)}
    .hr{height:1px;background:rgba(27,42,74,.7); margin:10px 0}
    .list{margin:0; padding-left:18px; color:var(--mut); line-height:1.45}
    .statusline{font-family:var(--mono); font-size:12px; color:var(--mut2); white-space:pre-wrap}
    .footer{margin-top:14px; color:var(--mut2); font-size:12px}
    .errorBox{border:1px solid rgba(255,77,109,.5); background:rgba(255,77,109,.08); color:#ffd1d9; padding:10px; border-radius:14px; font-family:var(--mono); font-size:12px; white-space:pre-wrap}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="inner">
        <div class="brand">MAGNIFY SCANNER</div>
        <div class="sub">Stable build • Cloudflare proxy • US full / Intl LIMITED • score + rulebook</div>

        <div class="row">
          <div class="input">
            <input id="ticker" value="AMD" autocomplete="off" autocapitalize="characters" spellcheck="false" placeholder="Ticker (e.g. RIME, GAMB, SHOP.TO, BHP.AX)">
          </div>

          <div class="pill">
            <select id="market">
              <option value="AUTO">AUTO (try suffixes)</option>
              <option value="US">US</option>
              <option value="CA">Canada (.TO/.V)</option>
              <option value="AU">Australia (.AX)</option>
              <option value="EU">Europe (varies)</option>
            </select>
          </div>

          <button class="btn" id="scanBtn">SCAN</button>
        </div>

        <div class="hint">
          Tip: Intl stocks often need suffix. With AUTO, app tries common variants. If your data plan can’t fetch candles for intl, it switches to LIMITED (quote-only scoring).
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Result</h3>
        <div class="big">
          <span id="sym">—</span>
          <span class="badge" id="modeBadge">MODE: —</span>
          <span class="badge" id="scoreBadge">SCORE: —</span>
          <span class="badge" id="signalBadge">SIGNAL: —</span>
        </div>

        <div class="kv">
          <div class="box"><div class="k">Price</div><div class="v" id="price">—</div></div>
          <div class="box"><div class="k">Change</div><div class="v" id="chg">—</div></div>
          <div class="box"><div class="k">Volume</div><div class="v" id="vol">—</div></div>
          <div class="box"><div class="k">Prev Close</div><div class="v" id="prev">—</div></div>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="score">SCORE</div>
          <div class="tab" data-tab="signals">SIGNALS</div>
          <div class="tab" data-tab="wt">WT CHECK</div>
          <div class="tab" data-tab="plan">PLAN</div>
          <div class="tab" data-tab="debug">DEBUG</div>
        </div>

        <div class="panel" id="panelScore"></div>
        <div class="panel" id="panelSignals" style="display:none"></div>
        <div class="panel" id="panelWT" style="display:none"></div>
        <div class="panel" id="panelPlan" style="display:none"></div>
        <div class="panel" id="panelDebug" style="display:none"></div>
      </div>

      <div class="card">
        <h3>Status</h3>
        <div class="statusline" id="status">Ready.</div>
        <div class="hr"></div>
        <div class="mono">
          Proxy: <span id="proxyUrl"></span><br/>
          Educational only. Not financial advice. High-risk markets.
        </div>
        <div class="footer">
          If you get nothing: open browser menu → “Desktop site” off/on, refresh, or clear site data.
        </div>
        <div id="err" style="display:none;margin-top:12px" class="errorBox"></div>
      </div>
    </div>
  </div>

<script>
/** ===========================
 *  CONFIG
 *  =========================== */
const PROXY_BASE = "https://magnify-proxy.orglatfood.workers.dev"; // <-- your Cloudflare Worker
document.getElementById("proxyUrl").textContent = PROXY_BASE;

/** ===========================
 *  UI HELPERS
 *  =========================== */
const el = (id)=>document.getElementById(id);
const setStatus = (t)=> el("status").textContent = t;
const showErr = (t)=>{ el("err").style.display = "block"; el("err").textContent = t; };
const clearErr = ()=>{ el("err").style.display = "none"; el("err").textContent = ""; };

function badge(elm, text, cls){
  elm.textContent = text;
  elm.classList.remove("ok","bad","warn");
  if (cls) elm.classList.add(cls);
}

function fmtNum(n){
  if (n === null || n === undefined || Number.isNaN(n)) return "—";
  const a = Math.abs(n);
  if (a >= 1e9) return (n/1e9).toFixed(2)+"B";
  if (a >= 1e6) return (n/1e6).toFixed(2)+"M";
  if (a >= 1e3) return (n/1e3).toFixed(2)+"K";
  return String(n);
}
function fmtPx(n){
  if (n === null || n === undefined || Number.isNaN(n)) return "—";
  return Number(n).toFixed(2);
}
function pct(n){
  if (n === null || n === undefined || Number.isNaN(n)) return "—";
  return (n*100).toFixed(2)+"%";
}

function switchTab(name){
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
  ["Score","Signals","WT","Plan","Debug"].forEach(key=>{
    el("panel"+key).style.display = (name.toLowerCase()===key.toLowerCase()) ? "block" : "none";
  });
}
document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click", ()=>switchTab(t.dataset.tab)));

/** ===========================
 *  API (via Cloudflare Worker)
 *  =========================== */
async function apiQuote(symbol){
  const r = await fetch(`${PROXY_BASE}/api/quote?symbol=${encodeURIComponent(symbol)}`, { cache: "no-store" });
  const j = await r.json();
  if (!j.ok) throw new Error(j.error || "Quote failed");
  return j.quote;
}

async function apiChart(symbol){
  const r = await fetch(`${PROXY_BASE}/api/chart?symbol=${encodeURIComponent(symbol)}&interval=1day&outputsize=200`, { cache: "no-store" });
  const j = await r.json();
  if (!j.ok) throw new Error(j.error || "Chart failed");
  return j; // { ok, symbol, interval, limited, candles:[...] }
}

/** ===========================
 *  SYMBOL NORMALIZATION
 *  =========================== */
function normalizeInput(s){
  return (s||"").trim().toUpperCase().replace(/\s+/g,"");
}

function expandAuto(symbol, market){
  // Returns an ordered list of candidates to try
  // IMPORTANT: With your current plan, intl may be LIMITED or unavailable. We still try.
  const base = symbol;
  const out = [];
  const hasSuffix = base.includes(".");
  if (market === "US") return [base];
  if (market === "CA") {
    if (hasSuffix) return [base];
    return [base+".TO", base+".V", base];
  }
  if (market === "AU") {
    if (hasSuffix) return [base];
    return [base+".AX", base];
  }
  if (market === "EU") {
    // Too many EU suffixes; try as-is first, then common ones used by Yahoo
    if (hasSuffix) return [base];
    return [base, base+".DE", base+".F", base+".PA", base+".AS", base+".MI", base+".L", base+".SW"];
  }
  // AUTO
  if (hasSuffix) return [base];
  out.push(base);                // US
  out.push(base+".TO", base+".V"); // Canada
  out.push(base+".AX");          // Australia
  out.push(base+".L", base+".DE", base+".PA", base+".AS", base+".MI", base+".SW", base+".F"); // Europe common
  return out;
}

/** ===========================
 *  SCORING + RULEBOOK
 *  - Works with FULL (candles) or LIMITED (quote only)
 *  =========================== */

// Technical helpers
function sma(values, len){
  if (!values || values.length < len) return null;
  let sum=0;
  for (let i=values.length-len;i<values.length;i++) sum+=values[i];
  return sum/len;
}

function atrFromCandles(candles, len=14){
  // candles: [{o,h,l,c,v,t}]
  if (!candles || candles.length < len+1) return null;
  const trs = [];
  for (let i=1;i<candles.length;i++){
    const c0 = candles[i-1];
    const c1 = candles[i];
    const tr = Math.max(
      c1.h - c1.l,
      Math.abs(c1.h - c0.c),
      Math.abs(c1.l - c0.c)
    );
    trs.push(tr);
  }
  if (trs.length < len) return null;
  const recent = trs.slice(-len);
  const avg = recent.reduce((a,b)=>a+b,0)/len;
  return avg;
}

function computeScore(quote, chartObj){
  // Output: {score, mode, signal, parts, plan}
  const price = Number(quote?.price);
  const prevClose = Number(quote?.previousClose);
  const chg = (price && prevClose) ? (price/prevClose - 1) : null;
  const vol = Number(quote?.volume ?? NaN);

  // Guards
  const inRange = (price >= 0.2 && price <= 50);
  const mode = chartObj?.limited ? "LIMITED" : "FULL";

  let score = 0;
  const parts = [];

  // 1) Price range filter (hard requirement)
  if (!inRange){
    parts.push({k:"Price range ($0.20–$50)", v:"FAIL", w:-40});
    score -= 40;
  } else {
    parts.push({k:"Price range ($0.20–$50)", v:"PASS", w:+10});
    score += 10;
  }

  // 2) Liquidity (quote-based)
  // crude: prefer > 300k daily volume for “tradable”; microcaps can be lower, but edge drops
  let liqScore = 0;
  if (!Number.isFinite(vol)) liqScore = 0;
  else if (vol >= 2_000_000) liqScore = 18;
  else if (vol >= 500_000) liqScore = 12;
  else if (vol >= 150_000) liqScore = 6;
  else liqScore = -10;
  score += liqScore;
  parts.push({k:"Liquidity (Volume)", v: fmtNum(vol), w: liqScore});

  // 3) Volatility / attention (quote-based via abs daily move)
  let moveScore = 0;
  if (chg !== null){
    const a = Math.abs(chg);
    if (a >= 0.15) moveScore = 18;
    else if (a >= 0.08) moveScore = 10;
    else if (a >= 0.04) moveScore = 4;
    else moveScore = -2;
  }
  score += moveScore;
  parts.push({k:"Daily move (abs)", v: (chg===null?"—":pct(Math.abs(chg))), w: moveScore});

  // 4) Candle-based momentum (FULL only)
  let momoScore = 0;
  let squeezeScore = 0;
  let atr = null;
  let aboveSMA20 = null;

  if (!chartObj?.limited && Array.isArray(chartObj?.candles) && chartObj.candles.length >= 30){
    const closes = chartObj.candles.map(x=>x.c);
    const vols = chartObj.candles.map(x=>x.v);
    const sma20 = sma(closes, 20);
    const sma50 = sma(closes, 50);
    const last = closes[closes.length-1];
    aboveSMA20 = (sma20!==null) ? last > sma20 : null;

    // Momentum: last close vs SMA20 and SMA50
    if (sma20 && sma50){
      if (last > sma20 && sma20 > sma50) momoScore = 20;
      else if (last > sma20) momoScore = 10;
      else if (last > sma50) momoScore = 4;
      else momoScore = -6;
    }
    score += momoScore;
    parts.push({k:"Trend (SMA20/SMA50)", v:`last ${fmtPx(last)} | sma20 ${fmtPx(sma20)} | sma50 ${fmtPx(sma50)}`, w:momoScore});

    // “Squeeze-ish”: ATR% low + rising volume today vs avg
    atr = atrFromCandles(chartObj.candles, 14);
    const atrPct = (atr && last) ? (atr/last) : null;
    const avgVol20 = sma(vols, 20);
    const vRatio = (avgVol20 && vols[vols.length-1]) ? (vols[vols.length-1]/avgVol20) : null;

    if (atrPct !== null){
      if (atrPct <= 0.03) squeezeScore += 8;     // tight
      else if (atrPct <= 0.05) squeezeScore += 4;
      else squeezeScore += 0;
    }
    if (vRatio !== null){
      if (vRatio >= 2.0) squeezeScore += 10;
      else if (vRatio >= 1.3) squeezeScore += 6;
      else if (vRatio >= 1.05) squeezeScore += 2;
      else squeezeScore -= 2;
    }

    score += squeezeScore;
    parts.push({k:"Volatility+Volume (ATR% + vRatio)", v:`ATR% ${atrPct===null?"—":pct(atrPct)} | vRatio ${vRatio===null?"—":vRatio.toFixed(2)}`, w:squeezeScore});
  } else {
    parts.push({k:"Trend / ATR / Volume Ratio", v:"LIMITED (no candles)", w:0});
  }

  // Normalize score to 0..100
  score = Math.max(0, Math.min(100, Math.round(score)));

  // Signal label
  let signal = "NO TRADE";
  if (score >= 80) signal = "A+ SETUP";
  else if (score >= 65) signal = "WATCH";
  else if (score >= 50) signal = "MAYBE";
  else signal = "PASS";

  // Rulebook plan (simple, executable)
  const plan = makePlan({score, quote, chartObj, atr, aboveSMA20});

  return { score, mode, signal, parts, plan };
}

function makePlan({score, quote, chartObj, atr, aboveSMA20}){
  const price = Number(quote?.price);
  const prevClose = Number(quote?.previousClose);
  const chg = (price && prevClose) ? (price/prevClose - 1) : null;

  // Base risk model: 1R = stop distance
  // FULL: stop uses ATR; LIMITED: stop uses % of price
  const hasCandles = !chartObj?.limited && Array.isArray(chartObj?.candles) && chartObj.candles.length >= 30;
  const stopDist = hasCandles && atr ? Math.max(atr*1.2, price*0.03) : price*0.05; // 5% if limited
  const stop = (price && stopDist) ? (price - stopDist) : null;
  const target1 = (price && stopDist) ? (price + stopDist*2) : null; // 2R
  const target2 = (price && stopDist) ? (price + stopDist*3) : null; // 3R

  // Entry trigger
  // FULL: require above SMA20 (trend) + score >= 80
  // LIMITED: require score >= 80 and day is green or strong move
  let entryRule = "";
  if (hasCandles){
    entryRule = "Enter only if price is ABOVE SMA20 AND score ≥ 80. Prefer entry on a 5–15 min pullback hold (not chasing).";
  } else {
    entryRule = "LIMITED mode: Enter only if score ≥ 80 AND (day is green OR abs day move ≥ 8%). Avoid illiquid names.";
  }

  // Position sizing rule (simple)
  const sizeRule =
`Position sizing:
- Risk per trade: 1.0% of account (max 2.0% if A+ and liquid).
- Shares = (Account * Risk%) / (Entry - Stop).
- Skip if stop distance implies < 0.2R wiggle (too tight) or > 10% (too wide).`;

  // Exit rules
  const exitRule =
`Exits:
- Hard stop at STOP.
- Take 1/2 at 2R (TARGET1), move stop to breakeven.
- Take rest at 3R (TARGET2) or trail below prior day low (FULL) / -5% from peak (LIMITED).`;

  // Filters
  const filters =
`Filters (must pass):
- Price must be $0.20–$50.
- Avoid obvious scams: reverse splits every few months, bankruptcy, fraud allegations.
- Avoid ultra-low volume (<150K/day) unless you accept slippage.`;

  // “No trade” override
  let verdict = "PASS";
  if (score >= 80) verdict = "TRADE (A+)";
  else if (score >= 65) verdict = "WATCHLIST";
  else verdict = "PASS";

  return {
    verdict,
    entryRule,
    stop: stop!==null ? stop : null,
    stopDist: stopDist!==null ? stopDist : null,
    target1: target1!==null ? target1 : null,
    target2: target2!==null ? target2 : null,
    sizeRule,
    exitRule,
    filters,
    chg
  };
}

/** ===========================
 *  RENDERING
 *  =========================== */
function renderAll(symbol, quote, chartObj, scored){
  el("sym").textContent = symbol;

  const modeCls = scored.mode === "FULL" ? "ok" : "warn";
  badge(el("modeBadge"), `MODE: ${scored.mode}`, modeCls);

  const s = scored.score;
  badge(el("scoreBadge"), `SCORE: ${s}/100`, s>=80 ? "ok" : (s>=65 ? "warn" : "bad"));
  badge(el("signalBadge"), `SIGNAL: ${scored.signal}`, s>=80 ? "ok" : (s>=65 ? "warn" : "bad"));

  el("price").textContent = fmtPx(quote?.price);
  const chg = (quote?.price && quote?.previousClose) ? (quote.price/quote.previousClose - 1) : null;
  el("chg").textContent = chg===null ? "—" : `${pct(chg)} (${chg>0?"+":" "}${(quote.price-quote.previousClose).toFixed(2)})`;
  el("vol").textContent = fmtNum(quote?.volume);
  el("prev").textContent = fmtPx(quote?.previousClose);

  // SCORE panel
  const lines = scored.parts.map(p=>{
    const sign = p.w>=0 ? "+" : "";
    return `<div style="display:flex;justify-content:space-between;gap:10px;margin:6px 0">
      <div style="color:var(--mut)">${escapeHtml(p.k)}</div>
      <div class="mono" style="text-align:right">${escapeHtml(p.v)} <span style="color:${p.w>=0?'var(--green)':'var(--red)'}">(${sign}${p.w})</span></div>
    </div>`;
  }).join("");
  el("panelScore").innerHTML = `
    <div class="mono">Score is designed for quick triage, not prediction. FULL mode uses trend/ATR/volume ratio; LIMITED uses quote-only scoring.</div>
    <div class="hr"></div>
    ${lines}
  `;

  // SIGNALS panel
  const signals = [];
  if (scored.mode === "LIMITED"){
    signals.push("LIMITED: no candles. Signals are quote-based only.");
  } else {
    signals.push("FULL: candles available. Trend and squeeze components active.");
  }
  if (quote?.price && quote?.previousClose){
    const abs = Math.abs(quote.price/quote.previousClose - 1);
    if (abs >= 0.15) signals.push("High attention: abs day move ≥ 15%.");
    else if (abs >= 0.08) signals.push("Attention: abs day move ≥ 8%.");
  }
  if (scored.score >= 80) signals.push("A+ threshold met (score ≥ 80).");
  else if (scored.score >= 65) signals.push("Watch threshold met (65–79).");
  else signals.push("Below threshold: pass unless special catalyst.");
  el("panelSignals").innerHTML = `<ul class="list">${signals.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`;

  // WT CHECK panel (simple “are you being fooled” checklist)
  el("panelWT").innerHTML = `
    <div class="mono">WT Check = “waste-time” filter. If any item is YES, reduce size or skip.</div>
    <div class="hr"></div>
    <ul class="list">
      <li>Is volume extremely low (&lt;150K/day) for your position size? (slippage risk)</li>
      <li>Recent reverse splits / repeated dilution?</li>
      <li>Press-release spam with no filings?</li>
      <li>Bankruptcy / fraud allegations / SEC warnings?</li>
      <li>Setup relies only on hope (no clear trigger, no stop)?</li>
    </ul>
  `;

  // PLAN panel (rulebook)
  const p = scored.plan;
  el("panelPlan").innerHTML = `
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
      <span class="badge">VERDICT: <b style="color:${p.verdict.includes("TRADE")?"var(--green)":p.verdict==="WATCHLIST"?"var(--amber)":"var(--red)"};margin-left:6px">${escapeHtml(p.verdict)}</b></span>
      <span class="badge">ENTRY: <span style="margin-left:6px">${escapeHtml(p.entryRule)}</span></span>
    </div>
    <div class="hr"></div>
    <div class="kv">
      <div class="box"><div class="k">Stop</div><div class="v">${p.stop===null?"—":fmtPx(p.stop)} <span style="color:var(--mut2)">(${p.stopDist?pct(p.stopDist/Number(quote.price)):"—"} dist)</span></div></div>
      <div class="box"><div class="k">Target 1 (2R)</div><div class="v">${p.target1===null?"—":fmtPx(p.target1)}</div></div>
      <div class="box"><div class="k">Target 2 (3R)</div><div class="v">${p.target2===null?"—":fmtPx(p.target2)}</div></div>
      <div class="box"><div class="k">Mode</div><div class="v">${escapeHtml(scored.mode)}</div></div>
    </div>
    <div class="hr"></div>
    <div class="mono" style="white-space:pre-wrap">${escapeHtml(p.filters)}</div>
    <div class="hr"></div>
    <div class="mono" style="white-space:pre-wrap">${escapeHtml(p.sizeRule)}</div>
    <div class="hr"></div>
    <div class="mono" style="white-space:pre-wrap">${escapeHtml(p.exitRule)}</div>
  `;

  // DEBUG panel
  el("panelDebug").innerHTML = `
    <div class="mono">Raw debug (safe):</div>
    <div class="hr"></div>
    <div class="mono" style="white-space:pre-wrap">${escapeHtml(JSON.stringify({
      symbol,
      mode: scored.mode,
      score: scored.score,
      limited: chartObj?.limited,
      candles: Array.isArray(chartObj?.candles) ? chartObj.candles.length : 0,
      quoteKeys: quote ? Object.keys(quote) : []
    }, null, 2))}</div>
  `;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** ===========================
 *  MAIN SCAN FLOW
 *  =========================== */
async function scan(){
  clearErr();
  switchTab("score");

  const raw = el("ticker").value;
  const market = el("market").value;
  const symIn = normalizeInput(raw);
  if (!symIn) return;

  const candidates = expandAuto(symIn, market);
  setStatus(`Scanning ${symIn}...\nTrying: ${candidates.join(", ")}\n`);

  // Try symbols until we get a valid QUOTE
  let chosen = null;
  let quote = null;
  let lastErr = null;

  for (const s of candidates){
    try{
      setStatus(`Trying quote: ${s} ...`);
      quote = await apiQuote(s);
      // basic sanity: must have price
      if (quote && Number.isFinite(Number(quote.price))){
        chosen = s;
        break;
      }
    }catch(e){
      lastErr = e;
    }
  }

  if (!chosen){
    showErr(`Could not fetch quote for any candidate.\nLast error: ${lastErr?.message || "unknown"}`);
    setStatus("Failed.");
    return;
  }

  setStatus(`Quote OK: ${chosen}\nFetching chart...`);

  // Chart is allowed to be LIMITED (no candles) without failing the scan
  let chartObj = null;
  try{
    chartObj = await apiChart(chosen);
  }catch(e){
    // If chart endpoint fails, fallback to LIMITED mode locally
    chartObj = { ok:true, symbol: chosen, interval:"1day", limited:true, candles:[] };
    setStatus(`Chart failed, using LIMITED local fallback.\nReason: ${e.message}`);
  }

  // Score + plan
  const scored = computeScore(quote, chartObj);

  // Render
  renderAll(chosen, quote, chartObj, scored);

  setStatus(
    `Done.\nSymbol: ${chosen}\nMode: ${scored.mode}\nScore: ${scored.score}/100\n`
  );
}

el("scanBtn").addEventListener("click", scan);
el("ticker").addEventListener("keydown", (e)=>{ if (e.key==="Enter") scan(); });

</script>
</body>
</html>
